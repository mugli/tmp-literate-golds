<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Source: fetch.go in package golang.org/x/pkgsite/internal/frontend</title>
<link href="../../../../../../css/lightLiterate-v0.3.2-preview.css" rel="stylesheet">
<script src="../../../../../../jvs/golds-v0.3.2-preview.js"></script>
<body onload="onPageLoad()"><div>

<pre id="header"><code><span class="title">Source File</span>
	fetch.go

<span class="title">Belonging Package</span>
	<a href="../../../../../../pkg/golang.org/x/pkgsite/internal/frontend.html">golang.org/x/pkgsite/internal/frontend</a>
</code></pre>
<style>input[type=radio] {display: none;}
input[id=r0]:checked ~pre label[for=r0],
input[id=r1]:checked ~pre label[for=r1],
input[id=r2]:checked ~pre label[for=r2],
input[id=r3]:checked ~pre label[for=r3],
input[id=r4]:checked ~pre label[for=r4],
input[id=r5]:checked ~pre label[for=r5],
input[id=r6]:checked ~pre label[for=r6],
input[id=r7]:checked ~pre label[for=r7],
input[id=r8]:checked ~pre label[for=r8],
input[id=r9]:checked ~pre label[for=r9],
input[id=r10]:checked ~pre label[for=r10],
input[id=r11]:checked ~pre label[for=r11],
input[id=r12]:checked ~pre label[for=r12],
input[id=r13]:checked ~pre label[for=r13],
input[id=r14]:checked ~pre label[for=r14],
input[id=r15]:checked ~pre label[for=r15],
input[id=r16]:checked ~pre label[for=r16],
input[id=r17]:checked ~pre label[for=r17],
input[id=r18]:checked ~pre label[for=r18],
input[id=r19]:checked ~pre label[for=r19],
input[id=r20]:checked ~pre label[for=r20],
input[id=r21]:checked ~pre label[for=r21],
input[id=r22]:checked ~pre label[for=r22],
input[id=r23]:checked ~pre label[for=r23],
input[id=r24]:checked ~pre label[for=r24],
input[id=r25]:checked ~pre label[for=r25],
input[id=r26]:checked ~pre label[for=r26],
input[id=r27]:checked ~pre label[for=r27],
input[id=r28]:checked ~pre label[for=r28],
input[id=r29]:checked ~pre label[for=r29],
input[id=r30]:checked ~pre label[for=r30],
input[id=r31]:checked ~pre label[for=r31],
input[id=r32]:checked ~pre label[for=r32],
input[id=r33]:checked ~pre label[for=r33],
input[id=r34]:checked ~pre label[for=r34],
input[id=r35]:checked ~pre label[for=r35],
input[id=r36]:checked ~pre label[for=r36],
input[id=r37]:checked ~pre label[for=r37],
input[id=r38]:checked ~pre label[for=r38],
input[id=r39]:checked ~pre label[for=r39],
input[id=r40]:checked ~pre label[for=r40],
input[id=r41]:checked ~pre label[for=r41],
input[id=r42]:checked ~pre label[for=r42],
input[id=r43]:checked ~pre label[for=r43],
input[id=r44]:checked ~pre label[for=r44],
input[id=r45]:checked ~pre label[for=r45],
input[id=r46]:checked ~pre label[for=r46],
input[id=r47]:checked ~pre label[for=r47],
input[id=r48]:checked ~pre label[for=r48],
input[id=r49]:checked ~pre label[for=r49],
input[id=r50]:checked ~pre label[for=r50],
input[id=r51]:checked ~pre label[for=r51],
input[id=r52]:checked ~pre label[for=r52],
input[id=r53]:checked ~pre label[for=r53],
input[id=r54]:checked ~pre label[for=r54],
input[id=r55]:checked ~pre label[for=r55],
input[id=r56]:checked ~pre label[for=r56],
input[id=r57]:checked ~pre label[for=r57],
input[id=r58]:checked ~pre label[for=r58],
input[id=r59]:checked ~pre label[for=r59],
input[id=r60]:checked ~pre label[for=r60],
input[id=r61]:checked ~pre label[for=r61],
input[id=r62]:checked ~pre label[for=r62],
input[id=r63]:checked ~pre label[for=r63],
input[id=r64]:checked ~pre label[for=r64],
input[id=r65]:checked ~pre label[for=r65],
input[id=r66]:checked ~pre label[for=r66],
input[id=r67]:checked ~pre label[for=r67],
input[id=r68]:checked ~pre label[for=r68],
input[id=r69]:checked ~pre label[for=r69],
input[id=r70]:checked ~pre label[for=r70],
input[id=r71]:checked ~pre label[for=r71],
input[id=r72]:checked ~pre label[for=r72],
input[id=r73]:checked ~pre label[for=r73],
input[id=r74]:checked ~pre label[for=r74],
input[id=r75]:checked ~pre label[for=r75],
input[id=r76]:checked ~pre label[for=r76],
input[id=r77]:checked ~pre label[for=r77],
input[id=r78]:checked ~pre label[for=r78],
input[id=r79]:checked ~pre label[for=r79],
input[id=r80]:checked ~pre label[for=r80],
input[id=r81]:checked ~pre label[for=r81],
input[id=r82]:checked ~pre label[for=r82],
input[id=r83]:checked ~pre label[for=r83],
input[id=r84]:checked ~pre label[for=r84],
input[id=r85]:checked ~pre label[for=r85],
input[id=r86]:checked ~pre label[for=r86],
input[id=r87]:checked ~pre label[for=r87],
input[id=r88]:checked ~pre label[for=r88],
input[id=r89]:checked ~pre label[for=r89],
input[id=r90]:checked ~pre label[for=r90],
input[id=r91]:checked ~pre label[for=r91],
input[id=r92]:checked ~pre label[for=r92],
input[id=r93]:checked ~pre label[for=r93],
input[id=r94]:checked ~pre label[for=r94],
input[id=r95]:checked ~pre label[for=r95],
input[id=r96]:checked ~pre label[for=r96],
input[id=r97]:checked ~pre label[for=r97],
input[id=r98]:checked ~pre label[for=r98],
input[id=r99]:checked ~pre label[for=r99],
input[id=r100]:checked ~pre label[for=r100],
input[id=r101]:checked ~pre label[for=r101],
input[id=r102]:checked ~pre label[for=r102],
input[id=r103]:checked ~pre label[for=r103],
input[id=r104]:checked ~pre label[for=r104],
input[id=r105]:checked ~pre label[for=r105],
input[id=r106]:checked ~pre label[for=r106],
input[id=r107]:checked ~pre label[for=r107],
input[id=r108]:checked ~pre label[for=r108],
input[id=r109]:checked ~pre label[for=r109],
input[id=r110]:checked ~pre label[for=r110],
input[id=r111]:checked ~pre label[for=r111],
input[id=r112]:checked ~pre label[for=r112],
input[id=r113]:checked ~pre label[for=r113],
input[id=r114]:checked ~pre label[for=r114],
input[id=r115]:checked ~pre label[for=r115],
input[id=r116]:checked ~pre label[for=r116],
input[id=r117]:checked ~pre label[for=r117],
input[id=r118]:checked ~pre label[for=r118],
input[id=r119]:checked ~pre label[for=r119],
input[id=r120]:checked ~pre label[for=r120],
input[id=r121]:checked ~pre label[for=r121],
input[id=r122]:checked ~pre label[for=r122],
input[id=r123]:checked ~pre label[for=r123],
input[id=r124]:checked ~pre label[for=r124],
input[id=r125]:checked ~pre label[for=r125]
{background: #226; color: #ff8;}
input[id=i0]:checked ~pre .i0,
input[id=i1]:checked ~pre .i1,
input[id=i2]:checked ~pre .i2,
input[id=i3]:checked ~pre .i3,
input[id=i4]:checked ~pre .i4,
input[id=i5]:checked ~pre .i5,
input[id=i6]:checked ~pre .i6,
input[id=i7]:checked ~pre .i7,
input[id=i8]:checked ~pre .i8,
input[id=i9]:checked ~pre .i9,
input[id=i10]:checked ~pre .i10,
input[id=i11]:checked ~pre .i11,
input[id=i12]:checked ~pre .i12,
input[id=i13]:checked ~pre .i13,
input[id=i14]:checked ~pre .i14,
input[id=i15]:checked ~pre .i15,
input[id=i16]:checked ~pre .i16,
input[id=i17]:checked ~pre .i17,
input[id=i18]:checked ~pre .i18,
input[id=i19]:checked ~pre .i19,
input[id=i20]:checked ~pre .i20
{background: brown; color: #eed;}
</style><input id="r0" type="radio" name="g"/>
<input id="r1" type="radio" name="g"/>
<input id="r2" type="radio" name="g"/>
<input id="r3" type="radio" name="g"/>
<input id="r4" type="radio" name="g"/>
<input id="r5" type="radio" name="g"/>
<input id="r6" type="radio" name="g"/>
<input id="r7" type="radio" name="g"/>
<input id="r8" type="radio" name="g"/>
<input id="r9" type="radio" name="g"/>
<input id="r10" type="radio" name="g"/>
<input id="r11" type="radio" name="g"/>
<input id="r12" type="radio" name="g"/>
<input id="r13" type="radio" name="g"/>
<input id="r14" type="radio" name="g"/>
<input id="r15" type="radio" name="g"/>
<input id="r16" type="radio" name="g"/>
<input id="r17" type="radio" name="g"/>
<input id="r18" type="radio" name="g"/>
<input id="r19" type="radio" name="g"/>
<input id="r20" type="radio" name="g"/>
<input id="r21" type="radio" name="g"/>
<input id="r22" type="radio" name="g"/>
<input id="r23" type="radio" name="g"/>
<input id="r24" type="radio" name="g"/>
<input id="r25" type="radio" name="g"/>
<input id="r26" type="radio" name="g"/>
<input id="r27" type="radio" name="g"/>
<input id="r28" type="radio" name="g"/>
<input id="r29" type="radio" name="g"/>
<input id="r30" type="radio" name="g"/>
<input id="r31" type="radio" name="g"/>
<input id="r32" type="radio" name="g"/>
<input id="r33" type="radio" name="g"/>
<input id="r34" type="radio" name="g"/>
<input id="r35" type="radio" name="g"/>
<input id="r36" type="radio" name="g"/>
<input id="r37" type="radio" name="g"/>
<input id="r38" type="radio" name="g"/>
<input id="r39" type="radio" name="g"/>
<input id="r40" type="radio" name="g"/>
<input id="r41" type="radio" name="g"/>
<input id="r42" type="radio" name="g"/>
<input id="r43" type="radio" name="g"/>
<input id="r44" type="radio" name="g"/>
<input id="r45" type="radio" name="g"/>
<input id="r46" type="radio" name="g"/>
<input id="r47" type="radio" name="g"/>
<input id="r48" type="radio" name="g"/>
<input id="r49" type="radio" name="g"/>
<input id="r50" type="radio" name="g"/>
<input id="r51" type="radio" name="g"/>
<input id="r52" type="radio" name="g"/>
<input id="r53" type="radio" name="g"/>
<input id="r54" type="radio" name="g"/>
<input id="r55" type="radio" name="g"/>
<input id="r56" type="radio" name="g"/>
<input id="r57" type="radio" name="g"/>
<input id="r58" type="radio" name="g"/>
<input id="r59" type="radio" name="g"/>
<input id="r60" type="radio" name="g"/>
<input id="r61" type="radio" name="g"/>
<input id="r62" type="radio" name="g"/>
<input id="r63" type="radio" name="g"/>
<input id="r64" type="radio" name="g"/>
<input id="r65" type="radio" name="g"/>
<input id="r66" type="radio" name="g"/>
<input id="r67" type="radio" name="g"/>
<input id="r68" type="radio" name="g"/>
<input id="r69" type="radio" name="g"/>
<input id="r70" type="radio" name="g"/>
<input id="r71" type="radio" name="g"/>
<input id="r72" type="radio" name="g"/>
<input id="r73" type="radio" name="g"/>
<input id="r74" type="radio" name="g"/>
<input id="r75" type="radio" name="g"/>
<input id="r76" type="radio" name="g"/>
<input id="r77" type="radio" name="g"/>
<input id="r78" type="radio" name="g"/>
<input id="r79" type="radio" name="g"/>
<input id="r80" type="radio" name="g"/>
<input id="r81" type="radio" name="g"/>
<input id="r82" type="radio" name="g"/>
<input id="r83" type="radio" name="g"/>
<input id="r84" type="radio" name="g"/>
<input id="r85" type="radio" name="g"/>
<input id="r86" type="radio" name="g"/>
<input id="r87" type="radio" name="g"/>
<input id="r88" type="radio" name="g"/>
<input id="r89" type="radio" name="g"/>
<input id="r90" type="radio" name="g"/>
<input id="r91" type="radio" name="g"/>
<input id="r92" type="radio" name="g"/>
<input id="r93" type="radio" name="g"/>
<input id="r94" type="radio" name="g"/>
<input id="r95" type="radio" name="g"/>
<input id="r96" type="radio" name="g"/>
<input id="r97" type="radio" name="g"/>
<input id="r98" type="radio" name="g"/>
<input id="r99" type="radio" name="g"/>
<input id="r100" type="radio" name="g"/>
<input id="r101" type="radio" name="g"/>
<input id="r102" type="radio" name="g"/>
<input id="r103" type="radio" name="g"/>
<input id="r104" type="radio" name="g"/>
<input id="r105" type="radio" name="g"/>
<input id="r106" type="radio" name="g"/>
<input id="r107" type="radio" name="g"/>
<input id="r108" type="radio" name="g"/>
<input id="r109" type="radio" name="g"/>
<input id="r110" type="radio" name="g"/>
<input id="r111" type="radio" name="g"/>
<input id="r112" type="radio" name="g"/>
<input id="r113" type="radio" name="g"/>
<input id="r114" type="radio" name="g"/>
<input id="r115" type="radio" name="g"/>
<input id="r116" type="radio" name="g"/>
<input id="r117" type="radio" name="g"/>
<input id="r118" type="radio" name="g"/>
<input id="r119" type="radio" name="g"/>
<input id="r120" type="radio" name="g"/>
<input id="r121" type="radio" name="g"/>
<input id="r122" type="radio" name="g"/>
<input id="r123" type="radio" name="g"/>
<input id="r124" type="radio" name="g"/>
<input id="r125" type="radio" name="g"/>
<input id="i0" type="radio" name="i"/>
<input id="i1" type="radio" name="i"/>
<input id="i2" type="radio" name="i"/>
<input id="i3" type="radio" name="i"/>
<input id="i4" type="radio" name="i"/>
<input id="i5" type="radio" name="i"/>
<input id="i6" type="radio" name="i"/>
<input id="i7" type="radio" name="i"/>
<input id="i8" type="radio" name="i"/>
<input id="i9" type="radio" name="i"/>
<input id="i10" type="radio" name="i"/>
<input id="i11" type="radio" name="i"/>
<input id="i12" type="radio" name="i"/>
<input id="i13" type="radio" name="i"/>
<input id="i14" type="radio" name="i"/>
<input id="i15" type="radio" name="i"/>
<input id="i16" type="radio" name="i"/>
<input id="i17" type="radio" name="i"/>
<input id="i18" type="radio" name="i"/>
<input id="i19" type="radio" name="i"/>
<input id="i20" type="radio" name="i"/>
<div id="container"><div class="section">
<div class="doc">
<span class="comment"> Copyright 2020 The Go Authors. All rights reserved.</span><span class="comment"> Use of this source code is governed by a BSD-style</span><span class="comment"> license that can be found in the LICENSE file.</span></div>
<div class="code"><pre><code>
<span class="keyword">package</span> frontend

<span class="keyword">import</span> (
	<label for="i0"><span class="lit-string i0">"context"</span></label>
	<label for="i1"><span class="lit-string i1">"errors"</span></label>
	<label for="i2"><span class="lit-string i2">"fmt"</span></label>
	<label for="i3"><span class="lit-string i3">"net/http"</span></label>
	<label for="i4"><span class="lit-string i4">"strconv"</span></label>
	<label for="i5"><span class="lit-string i5">"strings"</span></label>
	<label for="i6"><span class="lit-string i6">"sync"</span></label>
	<label for="i7"><span class="lit-string i7">"time"</span></label>

	<label for="i8"><span class="lit-string i8">"github.com/google/safehtml/template"</span></label>
	<label for="i9"><span class="lit-string i9">"go.opencensus.io/stats"</span></label>
	<label for="i10"><span class="lit-string i10">"go.opencensus.io/stats/view"</span></label>
	<label for="i11"><span class="lit-string i11">"go.opencensus.io/tag"</span></label>
	<label for="i12"><span class="lit-string i12">"golang.org/x/mod/module"</span></label>
	<label for="i13"><span class="lit-string i13">"golang.org/x/pkgsite/internal"</span></label>
	<label for="i14"><span class="lit-string i14">"golang.org/x/pkgsite/internal/derrors"</span></label>
	<label for="i15"><span class="lit-string i15">"golang.org/x/pkgsite/internal/fetch"</span></label>
	<label for="i16"><span class="lit-string i16">"golang.org/x/pkgsite/internal/log"</span></label>
	<label for="i17"><span class="lit-string i17">"golang.org/x/pkgsite/internal/postgres"</span></label>
	<label for="i18"><span class="lit-string i18">"golang.org/x/pkgsite/internal/proxy"</span></label>
	<label for="i19"><span class="lit-string i19">"golang.org/x/pkgsite/internal/source"</span></label>
	<label for="i20"><span class="lit-string i20">"golang.org/x/pkgsite/internal/stdlib"</span></label>
)

</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> errModuleDoesNotExist indicates that we have attempted to fetch the</span><span class="comment">	 module, and the proxy returned a status 404/410. There is a row for</span><span class="comment">	 this module version in version_map.</span></div>
<div class="code"><pre><code></code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> errPathDoesNotExistInModule indicates that a module for the path prefix</span><span class="comment">	 exists, but within that module version, this fullPath could not be found.</span></div>
<div class="code"><pre><code>	<a href="../../../../../../pkg/golang.org/x/pkgsite/internal/frontend.html#name-errPathDoesNotExistInModule" class="ident">errPathDoesNotExistInModule</a> = <a href="../../../../../../pkg/errors.html" class="ident i1">errors</a>.<a href="../../../../../errors/errors.go.html#line-58" class="ident">New</a>(<span class="lit-string">"path does not exist in module"</span>)
	<a href="../../../../../../pkg/golang.org/x/pkgsite/internal/frontend.html#name-fetchTimeout" class="ident">fetchTimeout</a>                = <span class="lit-number">30</span> * <a href="../../../../../../pkg/time.html" class="ident i7">time</a>.<a href="../../../../../time/time.go.html#line-605" class="ident">Second</a>
	<a href="../../../../../../pkg/golang.org/x/pkgsite/internal/frontend.html#name-pollEvery" class="ident">pollEvery</a>                   = <span class="lit-number">1</span> * <a href="../../../../../../pkg/time.html" class="ident i7">time</a>.<a href="../../../../../time/time.go.html#line-605" class="ident">Second</a>
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> keyFetchStatus is a census tag for frontend fetch status types.</span></div>
<div class="code"><pre><code></code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> frontendFetchLatency holds observed latency in individual</span><span class="comment">	 frontend fetch queries.</span></div>
<div class="code"><pre><code>	<a href="../../../../../../pkg/golang.org/x/pkgsite/internal/frontend.html#name-frontendFetchLatency" class="ident">frontendFetchLatency</a> = <a href="../../../../../../pkg/go.opencensus.io/stats.html" class="ident i9">stats</a>.<a href="../../../../../go.opencensus.io/stats/measure_float64.go.html#line-37" class="ident">Float64</a>(
		<span class="lit-string">"go-discovery/frontend-fetch/latency"</span>,
		<span class="lit-string">"Latency of a frontend fetch request."</span>,
		<a href="../../../../../../pkg/go.opencensus.io/stats.html" class="ident i9">stats</a>.<a href="../../../../../go.opencensus.io/stats/units.go.html#line-24" class="ident">UnitMilliseconds</a>,
	)
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> FetchLatencyDistribution aggregates frontend fetch request</span><span class="comment">	 latency by status code.</span></div>
<div class="code"><pre><code>	<a href="../../../../../../pkg/golang.org/x/pkgsite/internal/frontend.html#name-FetchLatencyDistribution" class="ident">FetchLatencyDistribution</a> = &amp;<a href="../../../../../../pkg/go.opencensus.io/stats/view.html" class="ident i10">view</a>.<a href="../../../../../go.opencensus.io/stats/view/view.go.html#line-35" class="ident">View</a>{
		<a href="../../../../../go.opencensus.io/stats/view/view.go.html#line-36" class="ident">Name</a>:    <span class="lit-string">"go-discovery/frontend-fetch/latency"</span>,
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> Modified from ochttp.DefaultLatencyDistribution to remove high</span><span class="comment">		 values. Because our unit is seconds rather than milliseconds, the</span><span class="comment">		 high values are too large (100000 = 27 hours). The main consequence</span><span class="comment">		 is that the Fetch Latency heatmap on the dashboard is less</span><span class="comment">		 informative.</span></div>
<div class="code"><pre><code>		<a href="../../../../../go.opencensus.io/stats/view/view.go.html#line-47" class="ident">Aggregation</a>: <a href="../../../../../../pkg/go.opencensus.io/stats/view.html" class="ident i10">view</a>.<a href="../../../../../go.opencensus.io/stats/view/aggregation.go.html#line-101" class="ident">Distribution</a>(
			<span class="lit-number">1</span>, <span class="lit-number">2</span>, <span class="lit-number">3</span>, <span class="lit-number">4</span>, <span class="lit-number">5</span>, <span class="lit-number">6</span>, <span class="lit-number">8</span>, <span class="lit-number">10</span>, <span class="lit-number">13</span>, <span class="lit-number">16</span>, <span class="lit-number">20</span>, <span class="lit-number">25</span>, <span class="lit-number">30</span>, <span class="lit-number">40</span>, <span class="lit-number">50</span>, <span class="lit-number">65</span>, <span class="lit-number">80</span>, <span class="lit-number">100</span>,
			<span class="lit-number">130</span>, <span class="lit-number">160</span>, <span class="lit-number">200</span>, <span class="lit-number">250</span>, <span class="lit-number">300</span>, <span class="lit-number">400</span>, <span class="lit-number">500</span>, <span class="lit-number">650</span>, <span class="lit-number">800</span>, <span class="lit-number">1000</span>,
			<span class="lit-number">30</span>*<span class="lit-number">60</span>, <span class="comment">// half hour: the max time an HTTP task can run</span>
			<span class="lit-number">60</span>*<span class="lit-number">60</span>),
		<a href="../../../../../go.opencensus.io/stats/view/view.go.html#line-37" class="ident">Description</a>: <span class="lit-string">"FrontendFetch latency, by result source query type."</span>,
		<a href="../../../../../go.opencensus.io/stats/view/view.go.html#line-41" class="ident">TagKeys</a>:     []<a href="../../../../../../pkg/go.opencensus.io/tag.html" class="ident i11">tag</a>.<a href="../../../../../go.opencensus.io/tag/key.go.html#line-19" class="ident">Key</a>{<a href="#line-44" class="ident">keyFetchStatus</a>},
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> FetchResponseCount counts frontend fetch responses by response type.</span></div>
<div class="code"><pre><code>	<a href="../../../../../../pkg/golang.org/x/pkgsite/internal/frontend.html#name-FetchResponseCount" class="ident">FetchResponseCount</a> = &amp;<a href="../../../../../../pkg/go.opencensus.io/stats/view.html" class="ident i10">view</a>.<a href="../../../../../go.opencensus.io/stats/view/view.go.html#line-35" class="ident">View</a>{
		<a href="../../../../../go.opencensus.io/stats/view/view.go.html#line-36" class="ident">Name</a>:        <span class="lit-string">"go-discovery/frontend-fetch/count"</span>,
		<a href="../../../../../go.opencensus.io/stats/view/view.go.html#line-44" class="ident">Measure</a>:     <a href="#line-47" class="ident">frontendFetchLatency</a>,
		<a href="../../../../../go.opencensus.io/stats/view/view.go.html#line-47" class="ident">Aggregation</a>: <a href="../../../../../../pkg/go.opencensus.io/stats/view.html" class="ident i10">view</a>.<a href="../../../../../go.opencensus.io/stats/view/aggregation.go.html#line-70" class="ident">Count</a>(),
		<a href="../../../../../go.opencensus.io/stats/view/view.go.html#line-37" class="ident">Description</a>: <span class="lit-string">"Frontend fetch request count"</span>,
		<a href="../../../../../go.opencensus.io/stats/view/view.go.html#line-41" class="ident">TagKeys</a>:     []<a href="../../../../../../pkg/go.opencensus.io/tag.html" class="ident i11">tag</a>.<a href="../../../../../go.opencensus.io/tag/key.go.html#line-19" class="ident">Key</a>{<a href="#line-44" class="ident">keyFetchStatus</a>},
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> statusNotFoundInVersionMap indicates that a row does not exist in</span><span class="comment">	 version_map for the module_path and requested_version.</span></div>
<div class="code"><pre><code>	<a href="../../../../../../pkg/golang.org/x/pkgsite/internal/frontend.html#name-statusNotFoundInVersionMap" class="ident">statusNotFoundInVersionMap</a> = <span class="lit-number">470</span>
)
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> serveFetch checks if a requested path and version exists in the database.</span><span class="comment"> If not, it will enqueuing potential module versions that could contain</span><span class="comment"> the requested path and version to a task queue, to be fetched by the worker.</span><span class="comment"> Meanwhile, the request will poll the database until a row is found, or a</span><span class="comment"> timeout occurs. A status and responseText will be returned based on the</span><span class="comment"> result of the request.</span></div>
<div class="code"><pre><code><span class="keyword">func</span> (<label for="r0" class="ident">s</label> *<a href="server.go.html#line-36" class="ident">Server</a>) <label for="r1" class="ident"><a href="../../../../../../use/golang.org/x/pkgsite/internal/frontend..Server.serveFetch*f99ca.html" class="ident">serveFetch</a></label>(<label for="r2" class="ident">w</label> <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/server.go.html#line-95" class="ident">ResponseWriter</a>, <label for="r3" class="ident">r</label> *<a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/request.go.html#line-102" class="ident">Request</a>, <label for="r4" class="ident">ds</label> <a href="../../../../../../pkg/golang.org/x/pkgsite/internal.html" class="ident i13">internal</a>.<a href="../datasource.go.html#line-10" class="ident">DataSource</a>) (<label for="r5" class="ident">err</label> <a href="../../../../../../pkg/builtin.html#name-error" class="ident">error</a>) {
	<span class="keyword">defer</span> <a href="../../../../../../pkg/golang.org/x/pkgsite/internal/derrors.html" class="ident i14">derrors</a>.<a href="../derrors/derrors.go.html#line-233" class="ident">Wrap</a>(&amp;<label for="r5" class="ident">err</label>, <span class="lit-string">"serveFetch(%q)"</span>, <label for="r3" class="ident">r</label>.<a href="../../../../../net/http/request.go.html#line-123" class="ident">URL</a>.<a href="../../../../../net/url/url.go.html#line-363" class="ident">Path</a>)
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> There's no reason for the proxydatasource to need this codepath.</span></div>
<div class="code"><pre><code>		<span class="keyword">return</span> <a href="details.go.html#line-92" class="ident">proxydatasourceNotSupportedErr</a>()
	}
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> If the experiment flag is not on, or the user makes a GET request,</span><span class="comment">		 treat this as a request for the "fetch" package, which does not</span><span class="comment">		 exist.</span></div>
<div class="code"><pre><code>		<span class="keyword">return</span> &amp;<a href="server.go.html#line-327" class="ident">serverError</a>{<a href="server.go.html#line-328" class="ident">status</a>: <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-40" class="ident">StatusNotFound</a>}
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> fetchHander accepts a requests following the same URL format as the</span><span class="comment">	 detailsHandler.</span></div>
<div class="code"><pre><code>	<label for="r8" class="ident">urlInfo</label>, <label for="r5" class="ident">err</label> := <a href="urlinfo.go.html#line-51" class="ident">extractURLPathInfo</a>(<a href="../../../../../../pkg/strings.html" class="ident i5">strings</a>.<a href="../../../../../strings/strings.go.html#line-902" class="ident">TrimPrefix</a>(<label for="r3" class="ident">r</label>.<a href="../../../../../net/http/request.go.html#line-123" class="ident">URL</a>.<a href="../../../../../net/url/url.go.html#line-363" class="ident">Path</a>, <span class="lit-string">"/fetch"</span>))
	<span class="keyword">if</span> <label for="r5" class="ident">err</label> != <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a> {
		<span class="keyword">return</span> &amp;<a href="server.go.html#line-327" class="ident">serverError</a>{<a href="server.go.html#line-328" class="ident">status</a>: <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-36" class="ident">StatusBadRequest</a>}
	}
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> TODO(https://golang.org/issue/39973): add support for fetching the</span><span class="comment">		 latest and master versions of the standard library.</span></div>
<div class="code"><pre><code>		(<a href="../../../../../../pkg/golang.org/x/pkgsite/internal/stdlib.html" class="ident i20">stdlib</a>.<a href="../stdlib/stdlib.go.html#line-501" class="ident">Contains</a>(<label for="r8" class="ident">urlInfo</label>.<a href="urlinfo.go.html#line-26" class="ident">fullPath</a>) &amp;&amp; <label for="r8" class="ident">urlInfo</label>.<a href="urlinfo.go.html#line-33" class="ident">requestedVersion</a> == <a href="../../../../../../pkg/golang.org/x/pkgsite/internal.html" class="ident i13">internal</a>.<a href="../discovery.go.html#line-22" class="ident">LatestVersion</a>) {
		<span class="keyword">return</span> &amp;<a href="server.go.html#line-327" class="ident">serverError</a>{<a href="server.go.html#line-328" class="ident">status</a>: <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-36" class="ident">StatusBadRequest</a>}
	}
	<label for="r9" class="ident">status</label>, <label for="r10" class="ident">responseText</label> := <label for="r0" class="ident">s</label>.<a href="#line-130" class="ident">fetchAndPoll</a>(<label for="r3" class="ident">r</label>.<a href="../../../../../net/http/request.go.html#line-336" class="ident">Context</a>(), <label for="r4" class="ident">ds</label>, <label for="r8" class="ident">urlInfo</label>.<a href="urlinfo.go.html#line-29" class="ident">modulePath</a>, <label for="r8" class="ident">urlInfo</label>.<a href="urlinfo.go.html#line-26" class="ident">fullPath</a>, <label for="r8" class="ident">urlInfo</label>.<a href="urlinfo.go.html#line-33" class="ident">requestedVersion</a>)
	<span class="keyword">if</span> <label for="r9" class="ident">status</label> != <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-15" class="ident">StatusOK</a> {
		<span class="keyword">return</span> &amp;<a href="server.go.html#line-327" class="ident">serverError</a>{<a href="server.go.html#line-328" class="ident">status</a>: <label for="r9" class="ident">status</label>, <a href="server.go.html#line-329" class="ident">responseText</a>: <label for="r10" class="ident">responseText</label>}
	}
	<span class="keyword">return</span> <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a>
}

<span class="keyword">type</span> <a href="../../../../../../pkg/golang.org/x/pkgsite/internal/frontend.html#name-fetchResult" class="ident">fetchResult</a> <span class="keyword">struct</span> {
	<a href="../../../../../../use/golang.org/x/pkgsite/internal/frontend..fetchResult*ded0d.modulePath*fd2f9.html" class="ident">modulePath</a>   <a href="../../../../../../pkg/builtin.html#name-string" class="ident">string</a>
	<a href="../../../../../../use/golang.org/x/pkgsite/internal/frontend..fetchResult*ded0d.goModPath*e25b0.html" class="ident">goModPath</a>    <a href="../../../../../../pkg/builtin.html#name-string" class="ident">string</a>
	<a href="../../../../../../use/golang.org/x/pkgsite/internal/frontend..fetchResult*ded0d.status*073c1.html" class="ident">status</a>       <a href="../../../../../../pkg/builtin.html#name-int" class="ident">int</a>
	<a href="../../../../../../use/golang.org/x/pkgsite/internal/frontend..fetchResult*ded0d.err*d9eb2.html" class="ident">err</a>          <a href="../../../../../../pkg/builtin.html#name-error" class="ident">error</a>
	<a href="../../../../../../use/golang.org/x/pkgsite/internal/frontend..fetchResult*ded0d.responseText*f6ea1.html" class="ident">responseText</a> <a href="../../../../../../pkg/builtin.html#name-string" class="ident">string</a>
	<a href="../../../../../../use/golang.org/x/pkgsite/internal/frontend..fetchResult*ded0d.updatedAt*e9502.html" class="ident">updatedAt</a>    <a href="../../../../../../pkg/time.html" class="ident i7">time</a>.<a href="../../../../../time/time.go.html#line-127" class="ident">Time</a>
}

<span class="keyword">func</span> (<label for="r11" class="ident">s</label> *<a href="server.go.html#line-36" class="ident">Server</a>) <label for="r12" class="ident"><a href="../../../../../../use/golang.org/x/pkgsite/internal/frontend..Server.fetchAndPoll*3ac25.html" class="ident">fetchAndPoll</a></label>(<label for="r13" class="ident">ctx</label> <a href="../../../../../../pkg/context.html" class="ident i0">context</a>.<a href="../../../../../context/context.go.html#line-62" class="ident">Context</a>, <label for="r14" class="ident">ds</label> <a href="../../../../../../pkg/golang.org/x/pkgsite/internal.html" class="ident i13">internal</a>.<a href="../datasource.go.html#line-10" class="ident">DataSource</a>, <label for="r15" class="ident">modulePath</label>, <label for="r16" class="ident">fullPath</label>, <label for="r17" class="ident">requestedVersion</label> <a href="../../../../../../pkg/builtin.html#name-string" class="ident">string</a>) (<label for="r18" class="ident">status</label> <a href="../../../../../../pkg/builtin.html#name-int" class="ident">int</a>, <label for="r19" class="ident">responseText</label> <a href="../../../../../../pkg/builtin.html#name-string" class="ident">string</a>) {
	<label for="r20" class="ident">start</label> := <a href="../../../../../../pkg/time.html" class="ident i7">time</a>.<a href="../../../../../time/time.go.html#line-1066" class="ident">Now</a>()
	<span class="keyword">defer</span> <span class="keyword">func</span>() {
		<a href="../../../../../../pkg/golang.org/x/pkgsite/internal/log.html" class="ident i16">log</a>.<a href="../log/log.go.html#line-174" class="ident">Infof</a>(<label for="r13" class="ident">ctx</label>, <span class="lit-string">"fetchAndPoll(ctx, ds, q, %q, %q, %q): status=%d, responseText=%q"</span>,
			<label for="r15" class="ident">modulePath</label>, <label for="r16" class="ident">fullPath</label>, <label for="r17" class="ident">requestedVersion</label>, <label for="r18" class="ident">status</label>, <label for="r19" class="ident">responseText</label>)
		<a href="#line-591" class="ident">recordFrontendFetchMetric</a>(<label for="r13" class="ident">ctx</label>, <label for="r18" class="ident">status</label>, <a href="../../../../../../pkg/time.html" class="ident i7">time</a>.<a href="../../../../../time/time.go.html#line-868" class="ident">Since</a>(<label for="r20" class="ident">start</label>))
	}()

</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> TODO(https://golang.org/issue/39973): add support for fetching the</span><span class="comment">		 latest and master versions of the standard library</span></div>
<div class="code"><pre><code>		(<a href="../../../../../../pkg/golang.org/x/pkgsite/internal/stdlib.html" class="ident i20">stdlib</a>.<a href="../stdlib/stdlib.go.html#line-501" class="ident">Contains</a>(<label for="r16" class="ident">fullPath</label>) &amp;&amp; <label for="r17" class="ident">requestedVersion</label> == <a href="../../../../../../pkg/golang.org/x/pkgsite/internal.html" class="ident i13">internal</a>.<a href="../discovery.go.html#line-22" class="ident">LatestVersion</a>) {
		<span class="keyword">return</span> <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-36" class="ident">StatusBadRequest</a>, <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-150" class="ident">StatusText</a>(<a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-36" class="ident">StatusBadRequest</a>)
	}
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> Generate all possible module paths for the fullPath.</span></div>
<div class="code"><pre><code>	<label for="r21" class="ident">db</label> := <label for="r14" class="ident">ds</label>.(*<a href="../../../../../../pkg/golang.org/x/pkgsite/internal/postgres.html" class="ident i17">postgres</a>.<a href="../postgres/postgres.go.html#line-20" class="ident">DB</a>)
	<label for="r22" class="ident">modulePaths</label>, <label for="r23" class="ident">err</label> := <a href="#line-490" class="ident">modulePathsToFetch</a>(<label for="r13" class="ident">ctx</label>, <label for="r21" class="ident">db</label>, <label for="r16" class="ident">fullPath</label>, <label for="r15" class="ident">modulePath</label>)
	<span class="keyword">if</span> <label for="r23" class="ident">err</label> != <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a> {
		<span class="keyword">var</span> <label for="r24" class="ident">serr</label> *<a href="server.go.html#line-327" class="ident">serverError</a>
		<span class="keyword">if</span> <a href="../../../../../../pkg/errors.html" class="ident i1">errors</a>.<a href="../../../../../errors/wrap.go.html#line-77" class="ident">As</a>(<label for="r23" class="ident">err</label>, &amp;<label for="r24" class="ident">serr</label>) {
			<span class="keyword">return</span> <label for="r24" class="ident">serr</label>.<a href="server.go.html#line-328" class="ident">status</a>, <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-150" class="ident">StatusText</a>(<label for="r24" class="ident">serr</label>.<a href="server.go.html#line-328" class="ident">status</a>)
		}
		<a href="../../../../../../pkg/golang.org/x/pkgsite/internal/log.html" class="ident i16">log</a>.<a href="../log/log.go.html#line-184" class="ident">Errorf</a>(<label for="r13" class="ident">ctx</label>, <span class="lit-string">"fetchAndPoll(ctx, ds, q, %q, %q, %q): %v"</span>, <label for="r15" class="ident">modulePath</label>, <label for="r16" class="ident">fullPath</label>, <label for="r17" class="ident">requestedVersion</label>, <label for="r23" class="ident">err</label>)
		<span class="keyword">return</span> <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-66" class="ident">StatusInternalServerError</a>, <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-150" class="ident">StatusText</a>(<a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-66" class="ident">StatusInternalServerError</a>)
	}
	<label for="r25" class="ident">results</label> := <label for="r11" class="ident">s</label>.<a href="#line-175" class="ident">checkPossibleModulePaths</a>(<label for="r13" class="ident">ctx</label>, <label for="r21" class="ident">db</label>, <label for="r16" class="ident">fullPath</label>, <label for="r17" class="ident">requestedVersion</label>, <label for="r22" class="ident">modulePaths</label>, <a href="../../../../../../pkg/builtin.html#name-true" class="ident">true</a>)
	<label for="r26" class="ident">fr</label>, <label for="r23" class="ident">err</label> := <a href="#line-230" class="ident">resultFromFetchRequest</a>(<label for="r25" class="ident">results</label>, <label for="r16" class="ident">fullPath</label>, <label for="r17" class="ident">requestedVersion</label>)
	<span class="keyword">if</span> <label for="r23" class="ident">err</label> != <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a> {
		<a href="../../../../../../pkg/golang.org/x/pkgsite/internal/log.html" class="ident i16">log</a>.<a href="../log/log.go.html#line-184" class="ident">Errorf</a>(<label for="r13" class="ident">ctx</label>, <span class="lit-string">"fetchAndPoll(ctx, ds, q, %q, %q, %q): %v"</span>, <label for="r15" class="ident">modulePath</label>, <label for="r16" class="ident">fullPath</label>, <label for="r17" class="ident">requestedVersion</label>, <label for="r23" class="ident">err</label>)
		<span class="keyword">return</span> <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-66" class="ident">StatusInternalServerError</a>, <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-150" class="ident">StatusText</a>(<a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-66" class="ident">StatusInternalServerError</a>)
	}
	<span class="keyword">if</span> <label for="r26" class="ident">fr</label>.<a href="#line-124" class="ident">status</a> == <a href="../../../../../../pkg/golang.org/x/pkgsite/internal/derrors.html" class="ident i14">derrors</a>.<a href="../derrors/derrors.go.html#line-177" class="ident">ToStatus</a>(<a href="../../../../../../pkg/golang.org/x/pkgsite/internal/derrors.html" class="ident i14">derrors</a>.<a href="../derrors/derrors.go.html#line-43" class="ident">AlternativeModule</a>) {
		<label for="r26" class="ident">fr</label>.<a href="#line-124" class="ident">status</a> = <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-40" class="ident">StatusNotFound</a>
	}
	<span class="keyword">return</span> <label for="r26" class="ident">fr</label>.<a href="#line-124" class="ident">status</a>, <label for="r26" class="ident">fr</label>.<a href="#line-126" class="ident">responseText</a>
}
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> checkPossibleModulePaths checks all modulePaths at the requestedVersion, to see</span><span class="comment"> if the fullPath exists. For each module path, it first checks version_map to</span><span class="comment"> see if we already attempted to fetch the module. If not, and shouldQueue is</span><span class="comment"> true, it will enqueue the module to the frontend task queue to be fetched.</span><span class="comment"> checkPossibleModulePaths will then poll the database for each module path,</span><span class="comment"> until a result is returned or the request times out. If shouldQueue is false,</span><span class="comment"> it will return the fetchResult, regardless of what the status is.</span></div>
<div class="code"><pre><code><span class="keyword">func</span> (<label for="r27" class="ident">s</label> *<a href="server.go.html#line-36" class="ident">Server</a>) <label for="r28" class="ident"><a href="../../../../../../use/golang.org/x/pkgsite/internal/frontend..Server.checkPossibleModulePaths*587b3.html" class="ident">checkPossibleModulePaths</a></label>(<label for="r29" class="ident">ctx</label> <a href="../../../../../../pkg/context.html" class="ident i0">context</a>.<a href="../../../../../context/context.go.html#line-62" class="ident">Context</a>, <label for="r30" class="ident">db</label> *<a href="../../../../../../pkg/golang.org/x/pkgsite/internal/postgres.html" class="ident i17">postgres</a>.<a href="../postgres/postgres.go.html#line-20" class="ident">DB</a>,
	<label for="r31" class="ident">fullPath</label>, <label for="r32" class="ident">requestedVersion</label> <a href="../../../../../../pkg/builtin.html#name-string" class="ident">string</a>, <label for="r33" class="ident">modulePaths</label> []<a href="../../../../../../pkg/builtin.html#name-string" class="ident">string</a>, <label for="r34" class="ident">shouldQueue</label> <a href="../../../../../../pkg/builtin.html#name-bool" class="ident">bool</a>) []*<a href="#line-121" class="ident">fetchResult</a> {
	<span class="keyword">var</span> <label for="r35" class="ident">wg</label> <a href="../../../../../../pkg/sync.html" class="ident i6">sync</a>.<a href="../../../../../sync/waitgroup.go.html#line-20" class="ident">WaitGroup</a>
	<label for="r29" class="ident">ctx</label>, <label for="r36" class="ident">cancel</label> := <a href="../../../../../../pkg/context.html" class="ident i0">context</a>.<a href="../../../../../context/context.go.html#line-502" class="ident">WithTimeout</a>(<label for="r29" class="ident">ctx</label>, <a href="#line-40" class="ident">fetchTimeout</a>)
	<span class="keyword">defer</span> <label for="r36" class="ident">cancel</label>()
	<label for="r37" class="ident">results</label> := <a href="../../../../../../pkg/builtin.html#name-make" class="ident">make</a>([]*<a href="#line-121" class="ident">fetchResult</a>, <a href="../../../../../../pkg/builtin.html#name-len" class="ident">len</a>(<label for="r33" class="ident">modulePaths</label>))
	<span class="keyword">for</span> <label for="r38" class="ident">i</label>, <label for="r39" class="ident">modulePath</label> := <span class="keyword">range</span> <label for="r33" class="ident">modulePaths</label> {
		<label for="r35" class="ident">wg</label>.<a href="../../../../../sync/waitgroup.go.html#line-53" class="ident">Add</a>(<span class="lit-number">1</span>)
		<label for="r40" class="ident">i</label> := <label for="r38" class="ident">i</label>
		<label for="r41" class="ident">modulePath</label> := <label for="r39" class="ident">modulePath</label>
		<span class="keyword">go</span> <span class="keyword">func</span>() {
			<span class="keyword">defer</span> <label for="r35" class="ident">wg</label>.<a href="../../../../../sync/waitgroup.go.html#line-98" class="ident">Done</a>()
			<label for="r42" class="ident">start</label> := <a href="../../../../../../pkg/time.html" class="ident i7">time</a>.<a href="../../../../../time/time.go.html#line-1066" class="ident">Now</a>()
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> Before enqueuing the module version to be fetched, check if we</span><span class="comment">			 have already attempted to fetch it in the past. If so, just</span><span class="comment">			 return the result from that fetch process.</span></div>
<div class="code"><pre><code>			<label for="r43" class="ident">fr</label> := <a href="#line-370" class="ident">checkForPath</a>(<label for="r29" class="ident">ctx</label>, <label for="r30" class="ident">db</label>, <label for="r31" class="ident">fullPath</label>, <label for="r41" class="ident">modulePath</label>, <label for="r32" class="ident">requestedVersion</label>, <label for="r27" class="ident">s</label>.<a href="server.go.html#line-43" class="ident">taskIDChangeInterval</a>)
			<a href="../../../../../../pkg/golang.org/x/pkgsite/internal/log.html" class="ident i16">log</a>.<a href="../log/log.go.html#line-189" class="ident">Debugf</a>(<label for="r29" class="ident">ctx</label>, <span class="lit-string">"initial checkForPath(ctx, db, %q, %q, %q, %d): status=%d, err=%v"</span>, <label for="r31" class="ident">fullPath</label>, <label for="r41" class="ident">modulePath</label>, <label for="r32" class="ident">requestedVersion</label>, <label for="r27" class="ident">s</label>.<a href="server.go.html#line-43" class="ident">taskIDChangeInterval</a>, <label for="r43" class="ident">fr</label>.<a href="#line-124" class="ident">status</a>, <label for="r43" class="ident">fr</label>.<a href="#line-125" class="ident">err</a>)
			<span class="keyword">if</span> !<label for="r34" class="ident">shouldQueue</label> || <label for="r43" class="ident">fr</label>.<a href="#line-124" class="ident">status</a> != <a href="#line-81" class="ident">statusNotFoundInVersionMap</a> {
				<label for="r37" class="ident">results</label>[<label for="r40" class="ident">i</label>] = <label for="r43" class="ident">fr</label>
				<span class="keyword">return</span>
			}
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> A row for this modulePath and requestedVersion combination does not</span><span class="comment">			 exist in version_map. Enqueue the module version to be fetched.</span></div>
<div class="code"><pre><code>			<span class="keyword">if</span> <label for="r44" class="ident">_</label>, <label for="r45" class="ident">err</label> := <label for="r27" class="ident">s</label>.<a href="server.go.html#line-39" class="ident">queue</a>.<a href="../queue/queue.go.html#line-34" class="ident">ScheduleFetch</a>(<label for="r29" class="ident">ctx</label>, <label for="r41" class="ident">modulePath</label>, <label for="r32" class="ident">requestedVersion</label>, <span class="lit-string">""</span>, <a href="../../../../../../pkg/builtin.html#name-false" class="ident">false</a>); <label for="r45" class="ident">err</label> != <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a> {
				<label for="r43" class="ident">fr</label>.<a href="#line-125" class="ident">err</a> = <label for="r45" class="ident">err</label>
				<label for="r43" class="ident">fr</label>.<a href="#line-124" class="ident">status</a> = <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-66" class="ident">StatusInternalServerError</a>
			}
			<a href="../../../../../../pkg/golang.org/x/pkgsite/internal/log.html" class="ident i16">log</a>.<a href="../log/log.go.html#line-189" class="ident">Debugf</a>(<label for="r29" class="ident">ctx</label>, <span class="lit-string">"queued %s@%s to frontend-fetch task queue"</span>, <label for="r41" class="ident">modulePath</label>, <label for="r32" class="ident">requestedVersion</label>)
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> After the fetch request is enqueued, poll the database until it has been</span><span class="comment">			 inserted or the request times out.</span></div>
<div class="code"><pre><code>			<label for="r43" class="ident">fr</label> = <a href="#line-336" class="ident">pollForPath</a>(<label for="r29" class="ident">ctx</label>, <label for="r30" class="ident">db</label>, <a href="#line-41" class="ident">pollEvery</a>, <label for="r31" class="ident">fullPath</label>, <label for="r41" class="ident">modulePath</label>, <label for="r32" class="ident">requestedVersion</label>, <label for="r27" class="ident">s</label>.<a href="server.go.html#line-43" class="ident">taskIDChangeInterval</a>)
			<label for="r46" class="ident">logf</label> := <a href="../../../../../../pkg/golang.org/x/pkgsite/internal/log.html" class="ident i16">log</a>.<a href="../log/log.go.html#line-174" class="ident">Infof</a>
			<span class="keyword">if</span> <label for="r43" class="ident">fr</label>.<a href="#line-124" class="ident">status</a> == <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-66" class="ident">StatusInternalServerError</a> {
				<label for="r46" class="ident">logf</label> = <a href="../../../../../../pkg/golang.org/x/pkgsite/internal/log.html" class="ident i16">log</a>.<a href="../log/log.go.html#line-184" class="ident">Errorf</a>
			}
			<label for="r46" class="ident">logf</label>(<label for="r29" class="ident">ctx</label>, <span class="lit-string">"fetched %s@%s for %s: status=%d, err=%v; took %.3fs"</span>, <label for="r41" class="ident">modulePath</label>, <label for="r32" class="ident">requestedVersion</label>, <label for="r31" class="ident">fullPath</label>, <label for="r43" class="ident">fr</label>.<a href="#line-124" class="ident">status</a>, <label for="r43" class="ident">fr</label>.<a href="#line-125" class="ident">err</a>, <a href="../../../../../../pkg/time.html" class="ident i7">time</a>.<a href="../../../../../time/time.go.html#line-868" class="ident">Since</a>(<label for="r42" class="ident">start</label>).<a href="../../../../../time/time.go.html#line-747" class="ident">Seconds</a>())
			<label for="r37" class="ident">results</label>[<label for="r40" class="ident">i</label>] = <label for="r43" class="ident">fr</label>
		}()
	}
	<label for="r35" class="ident">wg</label>.<a href="../../../../../sync/waitgroup.go.html#line-103" class="ident">Wait</a>()
	<span class="keyword">return</span> <label for="r37" class="ident">results</label>
}
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> resultFromFetchRequest returns the HTTP status code and response</span><span class="comment"> text from the results of fetching possible module paths for fullPath at the</span><span class="comment"> requestedVersion. It is assumed the results are sorted in order of</span><span class="comment"> decreasing modulePath length, so the first result that is not a</span><span class="comment"> StatusNotFound is returned. If all of the results are 404, but a module</span><span class="comment"> path was found that shares the path prefix of fullPath, the responseText will</span><span class="comment"> contain that information. The status and responseText will be displayed to the</span><span class="comment"> user.</span></div>
<div class="code"><pre><code><span class="keyword">func</span> <label for="r47" class="ident"><a href="../../../../../../pkg/golang.org/x/pkgsite/internal/frontend.html#name-resultFromFetchRequest" class="ident">resultFromFetchRequest</a></label>(<label for="r48" class="ident">results</label> []*<a href="#line-121" class="ident">fetchResult</a>, <label for="r49" class="ident">fullPath</label>, <label for="r50" class="ident">requestedVersion</label> <a href="../../../../../../pkg/builtin.html#name-string" class="ident">string</a>) (<label for="r51" class="ident">_</label> *<a href="#line-121" class="ident">fetchResult</a>, <label for="r52" class="ident">err</label> <a href="../../../../../../pkg/builtin.html#name-error" class="ident">error</a>) {
	<span class="keyword">defer</span> <a href="../../../../../../pkg/golang.org/x/pkgsite/internal/derrors.html" class="ident i14">derrors</a>.<a href="../derrors/derrors.go.html#line-233" class="ident">Wrap</a>(&amp;<label for="r52" class="ident">err</label>, <span class="lit-string">"resultFromFetchRequest(results, %q, %q)"</span>, <label for="r49" class="ident">fullPath</label>, <label for="r50" class="ident">requestedVersion</label>)
	<span class="keyword">if</span> <a href="../../../../../../pkg/builtin.html#name-len" class="ident">len</a>(<label for="r48" class="ident">results</label>) == <span class="lit-number">0</span> {
		<span class="keyword">return</span> <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a>, <a href="../../../../../../pkg/fmt.html" class="ident i2">fmt</a>.<a href="../../../../../fmt/errors.go.html#line-17" class="ident">Errorf</a>(<span class="lit-string">"no results"</span>)
	}

	<span class="keyword">var</span> <label for="r53" class="ident">moduleMatchingPathPrefix</label> <a href="../../../../../../pkg/builtin.html#name-string" class="ident">string</a>
	<span class="keyword">for</span> <label for="r54" class="ident">_</label>, <label for="r55" class="ident">fr</label> := <span class="keyword">range</span> <label for="r48" class="ident">results</label> {
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> Results are in order of longest module path first. Once an</span><span class="comment">		 appropriate result is found, return. Otherwise, look at the next</span><span class="comment">		 path.</span></div>
<div class="code"><pre><code>		<span class="keyword">case</span> <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-15" class="ident">StatusOK</a>:
			<span class="keyword">if</span> <label for="r55" class="ident">fr</label>.<a href="#line-125" class="ident">err</a> == <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a> {
				<span class="keyword">return</span> <label for="r55" class="ident">fr</label>, <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a>
			}
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> If the context timed out or was canceled before all of the requests</span><span class="comment">			 finished, return an error letting the user to check back later. The</span><span class="comment">			 worker will still be processing the modules in the background.</span></div>
<div class="code"><pre><code>			<label for="r55" class="ident">fr</label>.<a href="#line-126" class="ident">responseText</a> = <a href="../../../../../../pkg/fmt.html" class="ident i2">fmt</a>.<a href="../../../../../fmt/print.go.html#line-217" class="ident">Sprintf</a>(<span class="lit-string">"We're still working on %s. Check back in a few minutes!"</span>, <a href="#line-328" class="ident">displayPath</a>(<label for="r49" class="ident">fullPath</label>, <label for="r50" class="ident">requestedVersion</label>))
			<span class="keyword">return</span> <label for="r55" class="ident">fr</label>, <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a>
		<span class="keyword">case</span> <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-66" class="ident">StatusInternalServerError</a>:
			<label for="r55" class="ident">fr</label>.<a href="#line-126" class="ident">responseText</a> = <span class="lit-string">"Oops! Something went wrong."</span>
			<span class="keyword">return</span> <label for="r55" class="ident">fr</label>, <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a>
		<span class="keyword">case</span> <a href="../../../../../../pkg/golang.org/x/pkgsite/internal/derrors.html" class="ident i14">derrors</a>.<a href="../derrors/derrors.go.html#line-177" class="ident">ToStatus</a>(<a href="../../../../../../pkg/golang.org/x/pkgsite/internal/derrors.html" class="ident i14">derrors</a>.<a href="../derrors/derrors.go.html#line-43" class="ident">AlternativeModule</a>):
			<span class="keyword">if</span> <label for="r56" class="ident">err</label> := <a href="../../../../../../pkg/golang.org/x/mod/module.html" class="ident i12">module</a>.<a href="../../../mod/module/module.go.html#line-283" class="ident">CheckPath</a>(<label for="r55" class="ident">fr</label>.<a href="#line-123" class="ident">goModPath</a>); <label for="r56" class="ident">err</label> != <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a> {
				<label for="r55" class="ident">fr</label>.<a href="#line-124" class="ident">status</a> = <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-40" class="ident">StatusNotFound</a>
				<label for="r55" class="ident">fr</label>.<a href="#line-126" class="ident">responseText</a> = <a href="../../../../../../pkg/fmt.html" class="ident i2">fmt</a>.<a href="../../../../../fmt/print.go.html#line-217" class="ident">Sprintf</a>(<span class="lit-string">`%q does not have a valid module path (%q).`</span>, <label for="r49" class="ident">fullPath</label>, <label for="r55" class="ident">fr</label>.<a href="#line-123" class="ident">goModPath</a>)
				<span class="keyword">return</span> <label for="r55" class="ident">fr</label>, <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a>
			}
			<label for="r57" class="ident">t</label> := <a href="../../../../../../pkg/github.com/google/safehtml/template.html" class="ident i8">template</a>.<a href="../../../../../github.com/google/safehtml/template/template.go.html#line-433" class="ident">Must</a>(<a href="../../../../../../pkg/github.com/google/safehtml/template.html" class="ident i8">template</a>.<a href="../../../../../github.com/google/safehtml/template/template.go.html#line-330" class="ident">New</a>(<span class="lit-string">""</span>).<a href="../../../../../github.com/google/safehtml/template/template.go.html#line-239" class="ident">Parse</a>(<span class="lit-string">`{{.}}`</span>))
			<label for="r58" class="ident">h</label>, <label for="r59" class="ident">err</label> := <label for="r57" class="ident">t</label>.<a href="../../../../../github.com/google/safehtml/template/template.go.html#line-136" class="ident">ExecuteToHTML</a>(<a href="../../../../../../pkg/fmt.html" class="ident i2">fmt</a>.<a href="../../../../../fmt/print.go.html#line-217" class="ident">Sprintf</a>(<span class="lit-string">"%s is not a valid path. Were you looking for &lt;a href='https://pkg.go.dev/%s'&gt;%s&lt;/a&gt;?"</span>,
				<a href="#line-328" class="ident">displayPath</a>(<label for="r49" class="ident">fullPath</label>, <label for="r50" class="ident">requestedVersion</label>), <label for="r55" class="ident">fr</label>.<a href="#line-123" class="ident">goModPath</a>, <label for="r55" class="ident">fr</label>.<a href="#line-123" class="ident">goModPath</a>))
			<span class="keyword">if</span> <label for="r59" class="ident">err</label> != <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a> {
				<label for="r55" class="ident">fr</label>.<a href="#line-124" class="ident">status</a> = <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-66" class="ident">StatusInternalServerError</a>
				<span class="keyword">return</span> <label for="r55" class="ident">fr</label>, <label for="r59" class="ident">err</label>
			}
			<label for="r55" class="ident">fr</label>.<a href="#line-126" class="ident">responseText</a> = <label for="r58" class="ident">h</label>.<a href="../../../../../github.com/google/safehtml/html.go.html#line-59" class="ident">String</a>()
			<span class="keyword">return</span> <label for="r55" class="ident">fr</label>, <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a>
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> There are 3 categories of 490 errors that we see:</span><span class="comment">			 - module contains 0 packages</span><span class="comment">			 - empty commit time</span><span class="comment">			 - zip.NewReader: zip: not a valid zip file: bad module</span><span class="comment">			   (only seen for foo.maxj.us/oops.fossil)</span><span class="comment">			</span><span class="comment">			 Provide a specific message for the first error.</span></div>
<div class="code"><pre><code>			<label for="r55" class="ident">fr</label>.<a href="#line-124" class="ident">status</a> = <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-40" class="ident">StatusNotFound</a>
			<label for="r60" class="ident">p</label> := <label for="r49" class="ident">fullPath</label>
			<span class="keyword">if</span> <label for="r50" class="ident">requestedVersion</label> != <a href="../../../../../../pkg/golang.org/x/pkgsite/internal.html" class="ident i13">internal</a>.<a href="../discovery.go.html#line-22" class="ident">LatestVersion</a> {
				<label for="r60" class="ident">p</label> = <label for="r49" class="ident">fullPath</label> + <span class="lit-string">"@"</span> + <label for="r50" class="ident">requestedVersion</label>
			}
			<label for="r55" class="ident">fr</label>.<a href="#line-126" class="ident">responseText</a> = <a href="../../../../../../pkg/fmt.html" class="ident i2">fmt</a>.<a href="../../../../../fmt/print.go.html#line-217" class="ident">Sprintf</a>(<span class="lit-string">"%s could not be processed."</span>, <label for="r60" class="ident">p</label>)
			<span class="keyword">if</span> <label for="r55" class="ident">fr</label>.<a href="#line-125" class="ident">err</a> != <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a> &amp;&amp; <a href="../../../../../../pkg/strings.html" class="ident i5">strings</a>.<a href="../../../../../strings/strings.go.html#line-61" class="ident">Contains</a>(<label for="r55" class="ident">fr</label>.<a href="#line-125" class="ident">err</a>.Error(), <a href="../../../../../../pkg/golang.org/x/pkgsite/internal/fetch.html" class="ident i15">fetch</a>.<a href="../fetch/fetch.go.html#line-38" class="ident">ErrModuleContainsNoPackages</a>.Error()) {
				<label for="r55" class="ident">fr</label>.<a href="#line-126" class="ident">responseText</a> = <a href="../../../../../../pkg/fmt.html" class="ident i2">fmt</a>.<a href="../../../../../fmt/print.go.html#line-217" class="ident">Sprintf</a>(<span class="lit-string">"There are no packages in module %s."</span>, <label for="r60" class="ident">p</label>)
			}
			<span class="keyword">return</span> <label for="r55" class="ident">fr</label>, <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a>
		}
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> A module was found for a prefix of the path, but the path did not exist</span><span class="comment">		 in that module. Note the longest possible modulePath in this case, and</span><span class="comment">		 let the user know that it exists. For example, if the request was for</span><span class="comment">		 github.com/hashicorp/vault/@master/api, github.com/hashicorp/vault/api</span><span class="comment">		 does not exist at master, but it does in older versions of</span><span class="comment">		 github.com/hashicorp/vault.</span></div>
<div class="code"><pre><code>		<span class="keyword">if</span> <a href="../../../../../../pkg/errors.html" class="ident i1">errors</a>.<a href="../../../../../errors/wrap.go.html#line-39" class="ident">Is</a>(<label for="r55" class="ident">fr</label>.<a href="#line-125" class="ident">err</a>, <a href="#line-39" class="ident">errPathDoesNotExistInModule</a>) &amp;&amp; <label for="r53" class="ident">moduleMatchingPathPrefix</label> == <span class="lit-string">""</span> {
			<label for="r53" class="ident">moduleMatchingPathPrefix</label> = <label for="r55" class="ident">fr</label>.<a href="#line-122" class="ident">modulePath</a>
		}
	}

	<label for="r61" class="ident">fr</label> := <label for="r48" class="ident">results</label>[<span class="lit-number">0</span>]
	<span class="keyword">if</span> <label for="r53" class="ident">moduleMatchingPathPrefix</label> != <span class="lit-string">""</span> {
		<label for="r62" class="ident">t</label> := <a href="../../../../../../pkg/github.com/google/safehtml/template.html" class="ident i8">template</a>.<a href="../../../../../github.com/google/safehtml/template/template.go.html#line-433" class="ident">Must</a>(<a href="../../../../../../pkg/github.com/google/safehtml/template.html" class="ident i8">template</a>.<a href="../../../../../github.com/google/safehtml/template/template.go.html#line-330" class="ident">New</a>(<span class="lit-string">""</span>).<a href="../../../../../github.com/google/safehtml/template/template.go.html#line-239" class="ident">Parse</a>(<span class="lit-string">`{{.}}`</span>))
		<label for="r63" class="ident">h</label>, <label for="r64" class="ident">err</label> := <label for="r62" class="ident">t</label>.<a href="../../../../../github.com/google/safehtml/template/template.go.html#line-136" class="ident">ExecuteToHTML</a>(<a href="../../../../../../pkg/fmt.html" class="ident i2">fmt</a>.<a href="../../../../../fmt/print.go.html#line-217" class="ident">Sprintf</a>(<span class="lit-string">`</span>
<span class="lit-string">		    &lt;div class="Error-message"&gt;%s could not be found.&lt;/div&gt;</span>
<span class="lit-string">		    &lt;div class="Error-message"&gt;However, you can view &lt;a href="https://pkg.go.dev/%s"&gt;module %s&lt;/a&gt;.&lt;/div&gt;`</span>,
			<a href="#line-328" class="ident">displayPath</a>(<label for="r49" class="ident">fullPath</label>, <label for="r50" class="ident">requestedVersion</label>),
			<a href="#line-328" class="ident">displayPath</a>(<label for="r53" class="ident">moduleMatchingPathPrefix</label>, <label for="r50" class="ident">requestedVersion</label>),
			<a href="#line-328" class="ident">displayPath</a>(<label for="r53" class="ident">moduleMatchingPathPrefix</label>, <label for="r50" class="ident">requestedVersion</label>),
		))
		<span class="keyword">if</span> <label for="r64" class="ident">err</label> != <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a> {
			<label for="r61" class="ident">fr</label>.<a href="#line-124" class="ident">status</a> = <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-66" class="ident">StatusInternalServerError</a>
			<span class="keyword">return</span> <label for="r61" class="ident">fr</label>, <label for="r64" class="ident">err</label>
		}
		<label for="r61" class="ident">fr</label>.<a href="#line-124" class="ident">status</a> = <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-40" class="ident">StatusNotFound</a>
		<label for="r61" class="ident">fr</label>.<a href="#line-126" class="ident">responseText</a> = <label for="r63" class="ident">h</label>.<a href="../../../../../github.com/google/safehtml/html.go.html#line-59" class="ident">String</a>()
		<span class="keyword">return</span> <label for="r61" class="ident">fr</label>, <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a>
	}
	<label for="r65" class="ident">p</label> := <label for="r49" class="ident">fullPath</label>
	<span class="keyword">if</span> <label for="r50" class="ident">requestedVersion</label> != <a href="../../../../../../pkg/golang.org/x/pkgsite/internal.html" class="ident i13">internal</a>.<a href="../discovery.go.html#line-22" class="ident">LatestVersion</a> {
		<label for="r65" class="ident">p</label> = <label for="r49" class="ident">fullPath</label> + <span class="lit-string">"@"</span> + <label for="r50" class="ident">requestedVersion</label>
	}
	<label for="r61" class="ident">fr</label>.<a href="#line-124" class="ident">status</a> = <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-40" class="ident">StatusNotFound</a>
	<label for="r61" class="ident">fr</label>.<a href="#line-126" class="ident">responseText</a> = <a href="../../../../../../pkg/fmt.html" class="ident i2">fmt</a>.<a href="../../../../../fmt/print.go.html#line-217" class="ident">Sprintf</a>(<span class="lit-string">"%q could not be found."</span>, <label for="r65" class="ident">p</label>)
	<span class="keyword">return</span> <label for="r61" class="ident">fr</label>, <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a>
}

<span class="keyword">func</span> <label for="r66" class="ident"><a href="../../../../../../pkg/golang.org/x/pkgsite/internal/frontend.html#name-displayPath" class="ident">displayPath</a></label>(<label for="r67" class="ident">path</label>, <label for="r68" class="ident">version</label> <a href="../../../../../../pkg/builtin.html#name-string" class="ident">string</a>) <a href="../../../../../../pkg/builtin.html#name-string" class="ident">string</a> {
	<span class="keyword">if</span> <label for="r68" class="ident">version</label> == <a href="../../../../../../pkg/golang.org/x/pkgsite/internal.html" class="ident i13">internal</a>.<a href="../discovery.go.html#line-22" class="ident">LatestVersion</a> {
		<span class="keyword">return</span> <label for="r67" class="ident">path</label>
	}
	<span class="keyword">return</span> <a href="../../../../../../pkg/fmt.html" class="ident i2">fmt</a>.<a href="../../../../../fmt/print.go.html#line-217" class="ident">Sprintf</a>(<span class="lit-string">"%s@%s"</span>, <label for="r67" class="ident">path</label>, <label for="r68" class="ident">version</label>)
}
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> pollForPath polls the database until a row for fullPath is found.</span></div>
<div class="code"><pre><code><span class="keyword">func</span> <label for="r69" class="ident"><a href="../../../../../../pkg/golang.org/x/pkgsite/internal/frontend.html#name-pollForPath" class="ident">pollForPath</a></label>(<label for="r70" class="ident">ctx</label> <a href="../../../../../../pkg/context.html" class="ident i0">context</a>.<a href="../../../../../context/context.go.html#line-62" class="ident">Context</a>, <label for="r71" class="ident">db</label> *<a href="../../../../../../pkg/golang.org/x/pkgsite/internal/postgres.html" class="ident i17">postgres</a>.<a href="../postgres/postgres.go.html#line-20" class="ident">DB</a>, <label for="r72" class="ident">pollEvery</label> <a href="../../../../../../pkg/time.html" class="ident i7">time</a>.<a href="../../../../../time/time.go.html#line-583" class="ident">Duration</a>,
	<label for="r73" class="ident">fullPath</label>, <label for="r74" class="ident">modulePath</label>, <label for="r75" class="ident">requestedVersion</label> <a href="../../../../../../pkg/builtin.html#name-string" class="ident">string</a>, <label for="r76" class="ident">taskIDChangeInterval</label> <a href="../../../../../../pkg/time.html" class="ident i7">time</a>.<a href="../../../../../time/time.go.html#line-583" class="ident">Duration</a>) *<a href="#line-121" class="ident">fetchResult</a> {
	<label for="r77" class="ident">fr</label> := &amp;<a href="#line-121" class="ident">fetchResult</a>{<a href="#line-122" class="ident">modulePath</a>: <label for="r74" class="ident">modulePath</label>}
	<span class="keyword">defer</span> <a href="../../../../../../pkg/golang.org/x/pkgsite/internal/derrors.html" class="ident i14">derrors</a>.<a href="../derrors/derrors.go.html#line-233" class="ident">Wrap</a>(&amp;<label for="r77" class="ident">fr</label>.<a href="#line-125" class="ident">err</a>, <span class="lit-string">"pollForRedirectURL(%q, %q, %q)"</span>, <label for="r74" class="ident">modulePath</label>, <label for="r73" class="ident">fullPath</label>, <label for="r75" class="ident">requestedVersion</label>)
	<label for="r78" class="ident">ticker</label> := <a href="../../../../../../pkg/time.html" class="ident i7">time</a>.<a href="../../../../../time/tick.go.html#line-22" class="ident">NewTicker</a>(<label for="r72" class="ident">pollEvery</label>)
	<span class="keyword">defer</span> <label for="r78" class="ident">ticker</label>.<a href="../../../../../time/tick.go.html#line-46" class="ident">Stop</a>()
	<span class="keyword">for</span> {
		<a href="../../../../../runtime/select.go.html#line-121"><span class="keyword">select</span></a> {
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> The request timed out before the fetch process completed.</span></div>
<div class="code"><pre><code>			<label for="r77" class="ident">fr</label>.<a href="#line-124" class="ident">status</a> = <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-44" class="ident">StatusRequestTimeout</a>
			<label for="r77" class="ident">fr</label>.<a href="#line-125" class="ident">err</a> = <label for="r70" class="ident">ctx</label>.<a href="../../../../../context/context.go.html#line-106" class="ident">Err</a>()
			<span class="keyword">return</span> <label for="r77" class="ident">fr</label>
		<span class="keyword">case</span> <a href="../../../../../runtime/chan.go.html#line-438">&lt;-</a><label for="r78" class="ident">ticker</label>.<a href="../../../../../time/tick.go.html#line-12" class="ident">C</a>:
			<label for="r79" class="ident">ctx2</label>, <label for="r80" class="ident">cancel</label> := <a href="../../../../../../pkg/context.html" class="ident i0">context</a>.<a href="../../../../../context/context.go.html#line-502" class="ident">WithTimeout</a>(<label for="r70" class="ident">ctx</label>, <label for="r72" class="ident">pollEvery</label>)
			<span class="keyword">defer</span> <label for="r80" class="ident">cancel</label>()
			<label for="r77" class="ident">fr</label> = <a href="#line-370" class="ident">checkForPath</a>(<label for="r79" class="ident">ctx2</label>, <label for="r71" class="ident">db</label>, <label for="r73" class="ident">fullPath</label>, <label for="r74" class="ident">modulePath</label>, <label for="r75" class="ident">requestedVersion</label>, <label for="r76" class="ident">taskIDChangeInterval</label>)
			<span class="keyword">if</span> <label for="r77" class="ident">fr</label>.<a href="#line-124" class="ident">status</a> != <a href="#line-81" class="ident">statusNotFoundInVersionMap</a> {
				<span class="keyword">return</span> <label for="r77" class="ident">fr</label>
			}
		}
	}
}
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> checkForPath checks for the existence of fullPath, modulePath, and</span><span class="comment"> requestedVersion in the database. If the modulePath does not exist in</span><span class="comment"> version_map, it returns errModuleNotInVersionMap, signaling that the fetch</span><span class="comment"> process that was initiated is not yet complete.  If the row exists version_map</span><span class="comment"> but not paths, it means that a module was found at the requestedVersion, but</span><span class="comment"> not the fullPath, so errPathDoesNotExistInModule is returned.</span><span class="comment"></span><span class="comment"> Note that if an error occurs while writing to the version_map table,</span><span class="comment"> checkForPath will not know. Instead, it will keep running until the request</span><span class="comment"> times out.</span></div>
<div class="code"><pre><code><span class="keyword">func</span> <label for="r81" class="ident"><a href="../../../../../../pkg/golang.org/x/pkgsite/internal/frontend.html#name-checkForPath" class="ident">checkForPath</a></label>(<label for="r82" class="ident">ctx</label> <a href="../../../../../../pkg/context.html" class="ident i0">context</a>.<a href="../../../../../context/context.go.html#line-62" class="ident">Context</a>, <label for="r83" class="ident">db</label> *<a href="../../../../../../pkg/golang.org/x/pkgsite/internal/postgres.html" class="ident i17">postgres</a>.<a href="../postgres/postgres.go.html#line-20" class="ident">DB</a>,
	<label for="r84" class="ident">fullPath</label>, <label for="r85" class="ident">modulePath</label>, <label for="r86" class="ident">requestedVersion</label> <a href="../../../../../../pkg/builtin.html#name-string" class="ident">string</a>, <label for="r87" class="ident">taskIDChangeInterval</label> <a href="../../../../../../pkg/time.html" class="ident i7">time</a>.<a href="../../../../../time/time.go.html#line-583" class="ident">Duration</a>) (<label for="r88" class="ident">fr</label> *<a href="#line-121" class="ident">fetchResult</a>) {
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> Based on</span><span class="comment">		 https://github.com/lib/pq/issues/577#issuecomment-298341053, it seems</span><span class="comment">		 that ctx.Err() will return nil because this error is coming from</span><span class="comment">		 postgres. This is also how github.com/lib/pq currently handles the</span><span class="comment">		 error in their tests:</span><span class="comment">		 https://github.com/lib/pq/blob/e53edc9b26000fec4c4e357122d56b0f66ace6ea/go18_test.go#L89</span></div>
<div class="code"><pre><code>		<span class="keyword">if</span> <label for="r82" class="ident">ctx</label>.<a href="../../../../../context/context.go.html#line-106" class="ident">Err</a>() != <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a> || (<label for="r88" class="ident">fr</label>.<a href="#line-125" class="ident">err</a> != <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a> &amp;&amp; <a href="../../../../../../pkg/strings.html" class="ident i5">strings</a>.<a href="../../../../../strings/strings.go.html#line-61" class="ident">Contains</a>(<label for="r88" class="ident">fr</label>.<a href="#line-125" class="ident">err</a>.Error(), <span class="lit-string">"pq: canceling statement due to user request"</span>)) {
			<label for="r88" class="ident">fr</label>.<a href="#line-125" class="ident">err</a> = <a href="../../../../../../pkg/fmt.html" class="ident i2">fmt</a>.<a href="../../../../../fmt/errors.go.html#line-17" class="ident">Errorf</a>(<span class="lit-string">"%v: %w"</span>, <label for="r88" class="ident">fr</label>.<a href="#line-125" class="ident">err</a>, <a href="../../../../../../pkg/context.html" class="ident i0">context</a>.<a href="../../../../../context/context.go.html#line-161" class="ident">DeadlineExceeded</a>)
			<label for="r88" class="ident">fr</label>.<a href="#line-124" class="ident">status</a> = <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-44" class="ident">StatusRequestTimeout</a>
		}
		<a href="../../../../../../pkg/golang.org/x/pkgsite/internal/derrors.html" class="ident i14">derrors</a>.<a href="../derrors/derrors.go.html#line-233" class="ident">Wrap</a>(&amp;<label for="r88" class="ident">fr</label>.<a href="#line-125" class="ident">err</a>, <span class="lit-string">"checkForPath(%q, %q, %q)"</span>, <label for="r84" class="ident">fullPath</label>, <label for="r85" class="ident">modulePath</label>, <label for="r86" class="ident">requestedVersion</label>)
	}()
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> Check the version_map table to see if a row exists for modulePath and</span><span class="comment">	 requestedVersion.</span></div>
<div class="code"><pre><code>	<label for="r89" class="ident">vm</label>, <label for="r90" class="ident">err</label> := <label for="r83" class="ident">db</label>.<a href="../postgres/version_map.go.html#line-70" class="ident">GetVersionMap</a>(<label for="r82" class="ident">ctx</label>, <label for="r85" class="ident">modulePath</label>, <label for="r86" class="ident">requestedVersion</label>)
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> If an error is returned, there are two possibilities:</span><span class="comment">		 (1) A row for this modulePath and version does not exist.</span><span class="comment">		 This means that the fetch request is not done yet, so return</span><span class="comment">		 statusNotFoundInVersionMap so the fetchHandler will call checkForPath</span><span class="comment">		 again in a few seconds.</span><span class="comment">		 (2) Something went wrong, so return that error.</span></div>
<div class="code"><pre><code>		<label for="r88" class="ident">fr</label> = &amp;<a href="#line-121" class="ident">fetchResult</a>{
			<a href="#line-122" class="ident">modulePath</a>: <label for="r85" class="ident">modulePath</label>,
			<a href="#line-124" class="ident">status</a>:     <a href="../../../../../../pkg/golang.org/x/pkgsite/internal/derrors.html" class="ident i14">derrors</a>.<a href="../derrors/derrors.go.html#line-177" class="ident">ToStatus</a>(<label for="r90" class="ident">err</label>),
			<a href="#line-125" class="ident">err</a>:        <label for="r90" class="ident">err</label>,
		}
		<span class="keyword">if</span> <a href="../../../../../../pkg/errors.html" class="ident i1">errors</a>.<a href="../../../../../errors/wrap.go.html#line-39" class="ident">Is</a>(<label for="r90" class="ident">err</label>, <a href="../../../../../../pkg/golang.org/x/pkgsite/internal/derrors.html" class="ident i14">derrors</a>.<a href="../derrors/derrors.go.html#line-26" class="ident">NotFound</a>) {
			<label for="r88" class="ident">fr</label>.<a href="#line-124" class="ident">status</a> = <a href="#line-81" class="ident">statusNotFoundInVersionMap</a>
		}
		<span class="keyword">return</span> <label for="r88" class="ident">fr</label>
	}
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> We successfully retrieved a row in version_map for the modulePath and</span><span class="comment">	 requestedVersion. Look at the status of that row to determine whether</span><span class="comment">	 an error should be returned.</span></div>
<div class="code"><pre><code>	<label for="r88" class="ident">fr</label> = <a href="404.go.html#line-257" class="ident">fetchResultFromVersionMap</a>(<label for="r89" class="ident">vm</label>)

	<span class="keyword">switch</span> <label for="r88" class="ident">fr</label>.<a href="#line-124" class="ident">status</a> {
	<span class="keyword">case</span> <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-40" class="ident">StatusNotFound</a>,
		<a href="../../../../../../pkg/golang.org/x/pkgsite/internal/derrors.html" class="ident i14">derrors</a>.<a href="../derrors/derrors.go.html#line-177" class="ident">ToStatus</a>(<a href="../../../../../../pkg/golang.org/x/pkgsite/internal/derrors.html" class="ident i14">derrors</a>.<a href="../derrors/derrors.go.html#line-94" class="ident">DBModuleInsertInvalid</a>),
		<a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-66" class="ident">StatusInternalServerError</a>:
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> If the duration of taskIDChangeInterval has passed since</span><span class="comment">			 a module_path was last inserted into version_map with a failed status,</span><span class="comment">			 treat that data as expired.</span><span class="comment">			</span><span class="comment">			 It is possible that the module has appeared in the Go Module</span><span class="comment">			 Mirror during that time, the failure was transient, or the</span><span class="comment">			 error has been fixed but the module version has not yet been</span><span class="comment">			 reprocessed.</span><span class="comment">			</span><span class="comment">			 Return statusNotFoundInVersionMap here, so that the fetch</span><span class="comment">			 request will try to fetch this module version again.</span><span class="comment">			 Since the taskIDChangeInterval has passed, it is now possible to</span><span class="comment">			 enqueue that module version to the frontend task queue again.</span></div>
<div class="code"><pre><code>			<label for="r88" class="ident">fr</label>.<a href="#line-124" class="ident">status</a> = <a href="#line-81" class="ident">statusNotFoundInVersionMap</a>
			<span class="keyword">return</span> <label for="r88" class="ident">fr</label>
		}
		<span class="keyword">if</span> <label for="r88" class="ident">fr</label>.<a href="#line-124" class="ident">status</a> == <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-66" class="ident">StatusInternalServerError</a> {
			<label for="r88" class="ident">fr</label>.<a href="#line-125" class="ident">err</a> = <a href="../../../../../../pkg/fmt.html" class="ident i2">fmt</a>.<a href="../../../../../fmt/errors.go.html#line-17" class="ident">Errorf</a>(<span class="lit-string">"%q: %v"</span>, <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-150" class="ident">StatusText</a>(<label for="r88" class="ident">fr</label>.<a href="#line-124" class="ident">status</a>), <label for="r89" class="ident">vm</label>.<a href="../discovery.go.html#line-70" class="ident">Error</a>)
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> The version_map indicates that the proxy returned a 404/410.</span></div>
<div class="code"><pre><code>			<label for="r88" class="ident">fr</label>.<a href="#line-125" class="ident">err</a> = <a href="#line-36" class="ident">errModuleDoesNotExist</a>
		}
		<span class="keyword">return</span> <label for="r88" class="ident">fr</label>
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> The row indicates that the provided module path did not match the</span><span class="comment">		 module path returned by a request to</span><span class="comment">		 /&lt;modulePath&gt;/@v/&lt;requestedPath&gt;.mod.</span></div>
<div class="code"><pre><code>		<label for="r88" class="ident">fr</label>.<a href="#line-125" class="ident">err</a> = <a href="../../../../../../pkg/golang.org/x/pkgsite/internal/derrors.html" class="ident i14">derrors</a>.<a href="../derrors/derrors.go.html#line-43" class="ident">AlternativeModule</a>
		<span class="keyword">return</span> <label for="r88" class="ident">fr</label>
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> The module was marked for reprocessing by the worker.</span><span class="comment">		 Return statusNotFoundInVersionMap here, so that the tasks gets enqueued</span><span class="comment">		 to frontend tasks, and we don't return a result to the user until</span><span class="comment">		 that is complete.</span></div>
<div class="code"><pre><code>		<span class="keyword">if</span> <label for="r88" class="ident">fr</label>.<a href="#line-124" class="ident">status</a> &gt;= <a href="../../../../../../pkg/golang.org/x/pkgsite/internal/derrors.html" class="ident i14">derrors</a>.<a href="../derrors/derrors.go.html#line-177" class="ident">ToStatus</a>(<a href="../../../../../../pkg/golang.org/x/pkgsite/internal/derrors.html" class="ident i14">derrors</a>.<a href="../derrors/derrors.go.html#line-98" class="ident">ReprocessStatusOK</a>) {
			<label for="r88" class="ident">fr</label>.<a href="#line-124" class="ident">status</a> = <a href="#line-81" class="ident">statusNotFoundInVersionMap</a>
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> All remaining non-200 statuses will be in the 40x range.</span><span class="comment">		 In that case, just return a not found error.</span></div>
<div class="code"><pre><code>		<span class="keyword">if</span> <label for="r88" class="ident">fr</label>.<a href="#line-124" class="ident">status</a> &gt;= <span class="lit-number">400</span> {
			<label for="r88" class="ident">fr</label>.<a href="#line-124" class="ident">status</a> = <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-40" class="ident">StatusNotFound</a>
			<label for="r88" class="ident">fr</label>.<a href="#line-125" class="ident">err</a> = <a href="#line-36" class="ident">errModuleDoesNotExist</a>
			<span class="keyword">return</span>
		}
	}
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> The row in version_map indicated that the module version exists (status</span><span class="comment">	 was 200 or 290).  Now check the paths table to see if the fullPath exists.</span><span class="comment">	 vm.status for the module version was either a 200 or 290. Now determine if</span><span class="comment">	 the fullPath exists in that module.</span></div>
<div class="code"><pre><code>	<span class="keyword">if</span> <label for="r91" class="ident">_</label>, <label for="r92" class="ident">err</label> := <label for="r83" class="ident">db</label>.<a href="../postgres/unit.go.html#line-38" class="ident">GetUnitMeta</a>(<label for="r82" class="ident">ctx</label>, <label for="r84" class="ident">fullPath</label>, <label for="r85" class="ident">modulePath</label>, <label for="r89" class="ident">vm</label>.<a href="../discovery.go.html#line-67" class="ident">ResolvedVersion</a>); <label for="r92" class="ident">err</label> != <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a> {
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> The module version exists, but the fullPath does not exist in</span><span class="comment">			 that module version.</span></div>
<div class="code"><pre><code>			<label for="r88" class="ident">fr</label>.<a href="#line-125" class="ident">err</a> = <a href="#line-39" class="ident">errPathDoesNotExistInModule</a>
			<label for="r88" class="ident">fr</label>.<a href="#line-124" class="ident">status</a> = <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-40" class="ident">StatusNotFound</a>
			<span class="keyword">return</span> <label for="r88" class="ident">fr</label>
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> Something went wrong when we made the DB request to ds.GetUnitMeta.</span></div>
<div class="code"><pre><code>		<label for="r88" class="ident">fr</label>.<a href="#line-124" class="ident">status</a> = <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-66" class="ident">StatusInternalServerError</a>
		<label for="r88" class="ident">fr</label>.<a href="#line-125" class="ident">err</a> = <label for="r92" class="ident">err</label>
		<span class="keyword">return</span> <label for="r88" class="ident">fr</label>
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> Success! The fullPath exists in the requested module version.</span></div>
<div class="code"><pre><code>	<label for="r88" class="ident">fr</label>.<a href="#line-124" class="ident">status</a> = <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-15" class="ident">StatusOK</a>
	<span class="keyword">return</span> <label for="r88" class="ident">fr</label>
}
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> modulePathsToFetch returns the slice of module paths that we should check</span><span class="comment"> for the path. If modulePath is known, only check that modulePath. If a row</span><span class="comment"> for the fullPath already exists, check that modulePath. Otherwise, check all</span><span class="comment"> possible module paths based on the elements for the fullPath.</span><span class="comment"> Resulting paths are returned in reverse length order.</span></div>
<div class="code"><pre><code><span class="keyword">func</span> <label for="r93" class="ident"><a href="../../../../../../pkg/golang.org/x/pkgsite/internal/frontend.html#name-modulePathsToFetch" class="ident">modulePathsToFetch</a></label>(<label for="r94" class="ident">ctx</label> <a href="../../../../../../pkg/context.html" class="ident i0">context</a>.<a href="../../../../../context/context.go.html#line-62" class="ident">Context</a>, <label for="r95" class="ident">ds</label> <a href="../../../../../../pkg/golang.org/x/pkgsite/internal.html" class="ident i13">internal</a>.<a href="../datasource.go.html#line-10" class="ident">DataSource</a>, <label for="r96" class="ident">fullPath</label>, <label for="r97" class="ident">modulePath</label> <a href="../../../../../../pkg/builtin.html#name-string" class="ident">string</a>) (<label for="r98" class="ident">_</label> []<a href="../../../../../../pkg/builtin.html#name-string" class="ident">string</a>, <label for="r99" class="ident">err</label> <a href="../../../../../../pkg/builtin.html#name-error" class="ident">error</a>) {
	<span class="keyword">defer</span> <a href="../../../../../../pkg/golang.org/x/pkgsite/internal/derrors.html" class="ident i14">derrors</a>.<a href="../derrors/derrors.go.html#line-233" class="ident">Wrap</a>(&amp;<label for="r99" class="ident">err</label>, <span class="lit-string">"modulePathsToFetch(ctx, ds, %q, %q)"</span>, <label for="r96" class="ident">fullPath</label>, <label for="r97" class="ident">modulePath</label>)
	<span class="keyword">if</span> <label for="r97" class="ident">modulePath</label> != <a href="../../../../../../pkg/golang.org/x/pkgsite/internal.html" class="ident i13">internal</a>.<a href="../discovery.go.html#line-34" class="ident">UnknownModulePath</a> {
		<span class="keyword">return</span> []<a href="../../../../../../pkg/builtin.html#name-string" class="ident">string</a>{<label for="r97" class="ident">modulePath</label>}, <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a>
	}
	<label for="r100" class="ident">um</label>, <label for="r99" class="ident">err</label> := <label for="r95" class="ident">ds</label>.<a href="../datasource.go.html#line-22" class="ident">GetUnitMeta</a>(<label for="r94" class="ident">ctx</label>, <label for="r96" class="ident">fullPath</label>, <label for="r97" class="ident">modulePath</label>, <a href="../../../../../../pkg/golang.org/x/pkgsite/internal.html" class="ident i13">internal</a>.<a href="../discovery.go.html#line-22" class="ident">LatestVersion</a>)
	<span class="keyword">if</span> <label for="r99" class="ident">err</label> != <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a> &amp;&amp; !<a href="../../../../../../pkg/errors.html" class="ident i1">errors</a>.<a href="../../../../../errors/wrap.go.html#line-39" class="ident">Is</a>(<label for="r99" class="ident">err</label>, <a href="../../../../../../pkg/golang.org/x/pkgsite/internal/derrors.html" class="ident i14">derrors</a>.<a href="../derrors/derrors.go.html#line-26" class="ident">NotFound</a>) {
		<span class="keyword">return</span> <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a>, &amp;<a href="server.go.html#line-327" class="ident">serverError</a>{
			<a href="server.go.html#line-328" class="ident">status</a>: <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-66" class="ident">StatusInternalServerError</a>,
			<a href="server.go.html#line-331" class="ident">err</a>:    <label for="r99" class="ident">err</label>,
		}
	}
	<span class="keyword">if</span> <label for="r99" class="ident">err</label> == <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a> {
		<span class="keyword">return</span> []<a href="../../../../../../pkg/builtin.html#name-string" class="ident">string</a>{<label for="r100" class="ident">um</label>.<a href="../discovery.go.html#line-45" class="ident">ModulePath</a>}, <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a>
	}
	<span class="keyword">return</span> <a href="#line-523" class="ident">candidateModulePaths</a>(<label for="r96" class="ident">fullPath</label>)
}

<span class="keyword">var</span> <a href="../../../../../../pkg/golang.org/x/pkgsite/internal/frontend.html#name-vcsHostsWithThreeElementRepoName" class="ident">vcsHostsWithThreeElementRepoName</a> = <span class="keyword">map</span>[<a href="../../../../../../pkg/builtin.html#name-string" class="ident">string</a>]<a href="../../../../../../pkg/builtin.html#name-bool" class="ident">bool</a>{
	<span class="lit-string">"bitbucket.org"</span>: <a href="../../../../../../pkg/builtin.html#name-true" class="ident">true</a>,
	<span class="lit-string">"gitea.com"</span>:     <a href="../../../../../../pkg/builtin.html#name-true" class="ident">true</a>,
	<span class="lit-string">"gitee.com"</span>:     <a href="../../../../../../pkg/builtin.html#name-true" class="ident">true</a>,
	<span class="lit-string">"github.com"</span>:    <a href="../../../../../../pkg/builtin.html#name-true" class="ident">true</a>,
	<span class="lit-string">"gitlab.com"</span>:    <a href="../../../../../../pkg/builtin.html#name-true" class="ident">true</a>,
}
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> maxPathsToFetch is the number of modulePaths that are fetched from a single</span><span class="comment"> fetch request. The longest module path we've seen in our database had 7 path</span><span class="comment"> elements. maxPathsToFetch is set to 10 as a buffer.</span></div>
<div class="code"><pre><code><span class="keyword">var</span> <a href="../../../../../../pkg/golang.org/x/pkgsite/internal/frontend.html#name-maxPathsToFetch" class="ident">maxPathsToFetch</a> = <span class="lit-number">10</span>
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> candidateModulePaths returns the potential module paths that could contain</span><span class="comment"> the fullPath. The paths are returned in reverse length order.</span></div>
<div class="code"><pre><code><span class="keyword">func</span> <label for="r101" class="ident"><a href="../../../../../../pkg/golang.org/x/pkgsite/internal/frontend.html#name-candidateModulePaths" class="ident">candidateModulePaths</a></label>(<label for="r102" class="ident">fullPath</label> <a href="../../../../../../pkg/builtin.html#name-string" class="ident">string</a>) (<label for="r103" class="ident">_</label> []<a href="../../../../../../pkg/builtin.html#name-string" class="ident">string</a>, <label for="r104" class="ident">err</label> <a href="../../../../../../pkg/builtin.html#name-error" class="ident">error</a>) {
	<span class="keyword">if</span> !<a href="urlinfo.go.html#line-168" class="ident">isValidPath</a>(<label for="r102" class="ident">fullPath</label>) {
		<span class="keyword">return</span> <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a>, &amp;<a href="server.go.html#line-327" class="ident">serverError</a>{
			<a href="server.go.html#line-328" class="ident">status</a>: <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-36" class="ident">StatusBadRequest</a>,
			<a href="server.go.html#line-331" class="ident">err</a>:    <a href="../../../../../../pkg/fmt.html" class="ident i2">fmt</a>.<a href="../../../../../fmt/errors.go.html#line-17" class="ident">Errorf</a>(<span class="lit-string">"isValidPath(%q): false"</span>, <label for="r102" class="ident">fullPath</label>),
		}
	}
	<label for="r105" class="ident">paths</label> := <a href="../../../../../../pkg/golang.org/x/pkgsite/internal.html" class="ident i13">internal</a>.<a href="../paths.go.html#line-25" class="ident">CandidateModulePaths</a>(<label for="r102" class="ident">fullPath</label>)
	<span class="keyword">if</span> <label for="r105" class="ident">paths</label> == <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a> {
		<span class="keyword">return</span> <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a>, &amp;<a href="server.go.html#line-327" class="ident">serverError</a>{
			<a href="server.go.html#line-328" class="ident">status</a>: <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-36" class="ident">StatusBadRequest</a>,
			<a href="server.go.html#line-331" class="ident">err</a>:    <a href="../../../../../../pkg/fmt.html" class="ident i2">fmt</a>.<a href="../../../../../fmt/errors.go.html#line-17" class="ident">Errorf</a>(<span class="lit-string">"invalid path: %q"</span>, <label for="r102" class="ident">fullPath</label>),
		}
	}
	<span class="keyword">if</span> <a href="../../../../../../pkg/builtin.html#name-len" class="ident">len</a>(<label for="r105" class="ident">paths</label>) &gt; <a href="#line-519" class="ident">maxPathsToFetch</a> {
		<span class="keyword">return</span> <label for="r105" class="ident">paths</label>[<a href="../../../../../../pkg/builtin.html#name-len" class="ident">len</a>(<label for="r105" class="ident">paths</label>)-<a href="#line-519" class="ident">maxPathsToFetch</a>:], <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a>
	}
	<span class="keyword">return</span> <label for="r105" class="ident">paths</label>, <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a>
}
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> FetchAndUpdateState is used by the InMemory queue for testing in</span><span class="comment"> internal/frontend and running cmd/frontend locally. It is a copy of</span><span class="comment"> worker.FetchAndUpdateState that does not update module_version_states, so that</span><span class="comment"> we don't have to import internal/worker here. It is not meant to be used</span><span class="comment"> when running on AppEngine.</span></div>
<div class="code"><pre><code><span class="keyword">func</span> <label for="r106" class="ident"><a href="../../../../../../pkg/golang.org/x/pkgsite/internal/frontend.html#name-FetchAndUpdateState" class="ident">FetchAndUpdateState</a></label>(<label for="r107" class="ident">ctx</label> <a href="../../../../../../pkg/context.html" class="ident i0">context</a>.<a href="../../../../../context/context.go.html#line-62" class="ident">Context</a>, <label for="r108" class="ident">modulePath</label>, <label for="r109" class="ident">requestedVersion</label> <a href="../../../../../../pkg/builtin.html#name-string" class="ident">string</a>, <label for="r110" class="ident">proxyClient</label> *<a href="../../../../../../pkg/golang.org/x/pkgsite/internal/proxy.html" class="ident i18">proxy</a>.<a href="../proxy/client.go.html#line-31" class="ident">Client</a>, <label for="r111" class="ident">sourceClient</label> *<a href="../../../../../../pkg/golang.org/x/pkgsite/internal/source.html" class="ident i19">source</a>.<a href="../source/source.go.html#line-208" class="ident">Client</a>, <label for="r112" class="ident">db</label> *<a href="../../../../../../pkg/golang.org/x/pkgsite/internal/postgres.html" class="ident i17">postgres</a>.<a href="../postgres/postgres.go.html#line-20" class="ident">DB</a>) (<label for="r113" class="ident">_</label> <a href="../../../../../../pkg/builtin.html#name-int" class="ident">int</a>, <label for="r114" class="ident">err</label> <a href="../../../../../../pkg/builtin.html#name-error" class="ident">error</a>) {
	<span class="keyword">defer</span> <span class="keyword">func</span>() {
		<span class="keyword">if</span> <label for="r114" class="ident">err</label> != <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a> {
			<a href="../../../../../../pkg/golang.org/x/pkgsite/internal/log.html" class="ident i16">log</a>.<a href="../log/log.go.html#line-174" class="ident">Infof</a>(<label for="r107" class="ident">ctx</label>, <span class="lit-string">"FetchAndUpdateState(%q, %q) completed with err: %v. "</span>, <label for="r108" class="ident">modulePath</label>, <label for="r109" class="ident">requestedVersion</label>, <label for="r114" class="ident">err</label>)
		} <span class="keyword">else</span> {
			<a href="../../../../../../pkg/golang.org/x/pkgsite/internal/log.html" class="ident i16">log</a>.<a href="../log/log.go.html#line-174" class="ident">Infof</a>(<label for="r107" class="ident">ctx</label>, <span class="lit-string">"FetchAndUpdateState(%q, %q) succeeded"</span>, <label for="r108" class="ident">modulePath</label>, <label for="r109" class="ident">requestedVersion</label>)
		}
		<a href="../../../../../../pkg/golang.org/x/pkgsite/internal/derrors.html" class="ident i14">derrors</a>.<a href="../derrors/derrors.go.html#line-233" class="ident">Wrap</a>(&amp;<label for="r114" class="ident">err</label>, <span class="lit-string">"FetchAndUpdateState(%q, %q)"</span>, <label for="r108" class="ident">modulePath</label>, <label for="r109" class="ident">requestedVersion</label>)
	}()

	<label for="r115" class="ident">fr</label> := <a href="../../../../../../pkg/golang.org/x/pkgsite/internal/fetch.html" class="ident i15">fetch</a>.<a href="../fetch/fetch.go.html#line-119" class="ident">FetchModule</a>(<label for="r107" class="ident">ctx</label>, <label for="r108" class="ident">modulePath</label>, <label for="r109" class="ident">requestedVersion</label>, <label for="r110" class="ident">proxyClient</label>, <label for="r111" class="ident">sourceClient</label>)
	<span class="keyword">defer</span> <label for="r115" class="ident">fr</label>.<a href="../fetch/fetch.go.html#line-105" class="ident">Defer</a>()
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> Only attempt to insert the module into module_version_states if the</span><span class="comment">		 fetch process was successful.</span></div>
<div class="code"><pre><code>		<span class="keyword">if</span> <label for="r116" class="ident">_</label>, <label for="r117" class="ident">err</label> := <label for="r112" class="ident">db</label>.<a href="../postgres/insert_module.go.html#line-35" class="ident">InsertModule</a>(<label for="r107" class="ident">ctx</label>, <label for="r115" class="ident">fr</label>.<a href="../fetch/fetch.go.html#line-106" class="ident">Module</a>, <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a>); <label for="r117" class="ident">err</label> != <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a> {
			<label for="r115" class="ident">fr</label>.<a href="../fetch/fetch.go.html#line-103" class="ident">Status</a> = <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-66" class="ident">StatusInternalServerError</a>
			<a href="../../../../../../pkg/golang.org/x/pkgsite/internal/log.html" class="ident i16">log</a>.<a href="../log/log.go.html#line-184" class="ident">Errorf</a>(<label for="r107" class="ident">ctx</label>, <span class="lit-string">"FetchAndUpdateState(%q, %q): db.InsertModule failed: %v"</span>, <label for="r108" class="ident">modulePath</label>, <label for="r109" class="ident">requestedVersion</label>, <label for="r117" class="ident">err</label>)
		}
		<a href="../../../../../../pkg/golang.org/x/pkgsite/internal/log.html" class="ident i16">log</a>.<a href="../log/log.go.html#line-174" class="ident">Infof</a>(<label for="r107" class="ident">ctx</label>, <span class="lit-string">"FetchAndUpdateState(%q, %q): db.InsertModule succeeded"</span>, <label for="r108" class="ident">modulePath</label>, <label for="r109" class="ident">requestedVersion</label>)
	}

	<span class="keyword">var</span> <label for="r118" class="ident">errMsg</label> <a href="../../../../../../pkg/builtin.html#name-string" class="ident">string</a>
	<span class="keyword">if</span> <label for="r115" class="ident">fr</label>.<a href="../fetch/fetch.go.html#line-104" class="ident">Error</a> != <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a> {
		<label for="r118" class="ident">errMsg</label> = <label for="r115" class="ident">fr</label>.<a href="../fetch/fetch.go.html#line-104" class="ident">Error</a>.Error()
	}
	<label for="r119" class="ident">vm</label> := &amp;<a href="../../../../../../pkg/golang.org/x/pkgsite/internal.html" class="ident i13">internal</a>.<a href="../discovery.go.html#line-64" class="ident">VersionMap</a>{
		<a href="../discovery.go.html#line-65" class="ident">ModulePath</a>:       <label for="r115" class="ident">fr</label>.<a href="../fetch/fetch.go.html#line-93" class="ident">ModulePath</a>,
		<a href="../discovery.go.html#line-66" class="ident">RequestedVersion</a>: <label for="r115" class="ident">fr</label>.<a href="../fetch/fetch.go.html#line-94" class="ident">RequestedVersion</a>,
		<a href="../discovery.go.html#line-67" class="ident">ResolvedVersion</a>:  <label for="r115" class="ident">fr</label>.<a href="../fetch/fetch.go.html#line-95" class="ident">ResolvedVersion</a>,
		<a href="../discovery.go.html#line-68" class="ident">GoModPath</a>:        <label for="r115" class="ident">fr</label>.<a href="../fetch/fetch.go.html#line-102" class="ident">GoModPath</a>,
		<a href="../discovery.go.html#line-69" class="ident">Status</a>:           <label for="r115" class="ident">fr</label>.<a href="../fetch/fetch.go.html#line-103" class="ident">Status</a>,
		<a href="../discovery.go.html#line-70" class="ident">Error</a>:            <label for="r118" class="ident">errMsg</label>,
	}
	<span class="keyword">if</span> <label for="r120" class="ident">err</label> := <label for="r112" class="ident">db</label>.<a href="../postgres/version_map.go.html#line-20" class="ident">UpsertVersionMap</a>(<label for="r107" class="ident">ctx</label>, <label for="r119" class="ident">vm</label>); <label for="r120" class="ident">err</label> != <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a> {
		<span class="keyword">return</span> <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-66" class="ident">StatusInternalServerError</a>, <label for="r120" class="ident">err</label>
	}
	<span class="keyword">if</span> <label for="r115" class="ident">fr</label>.<a href="../fetch/fetch.go.html#line-104" class="ident">Error</a> != <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a> {
		<span class="keyword">return</span> <label for="r115" class="ident">fr</label>.<a href="../fetch/fetch.go.html#line-103" class="ident">Status</a>, <label for="r115" class="ident">fr</label>.<a href="../fetch/fetch.go.html#line-104" class="ident">Error</a>
	}
	<span class="keyword">return</span> <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-15" class="ident">StatusOK</a>, <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a>
}

<span class="keyword">func</span> <label for="r121" class="ident"><a href="../../../../../../pkg/golang.org/x/pkgsite/internal/frontend.html#name-recordFrontendFetchMetric" class="ident">recordFrontendFetchMetric</a></label>(<label for="r122" class="ident">ctx</label> <a href="../../../../../../pkg/context.html" class="ident i0">context</a>.<a href="../../../../../context/context.go.html#line-62" class="ident">Context</a>, <label for="r123" class="ident">status</label> <a href="../../../../../../pkg/builtin.html#name-int" class="ident">int</a>, <label for="r124" class="ident">latency</label> <a href="../../../../../../pkg/time.html" class="ident i7">time</a>.<a href="../../../../../time/time.go.html#line-583" class="ident">Duration</a>) {
	<label for="r125" class="ident">l</label> := <a href="../../../../../../pkg/builtin.html#name-float64" class="ident">float64</a>(<label for="r124" class="ident">latency</label>) / <a href="../../../../../../pkg/builtin.html#name-float64" class="ident">float64</a>(<a href="../../../../../../pkg/time.html" class="ident i7">time</a>.<a href="../../../../../time/time.go.html#line-604" class="ident">Millisecond</a>)

	<a href="../../../../../../pkg/go.opencensus.io/stats.html" class="ident i9">stats</a>.<a href="../../../../../go.opencensus.io/stats/record.go.html#line-100" class="ident">RecordWithTags</a>(<label for="r122" class="ident">ctx</label>, []<a href="../../../../../../pkg/go.opencensus.io/tag.html" class="ident i11">tag</a>.<a href="../../../../../go.opencensus.io/tag/map.go.html#line-96" class="ident">Mutator</a>{
		<a href="../../../../../../pkg/go.opencensus.io/tag.html" class="ident i11">tag</a>.<a href="../../../../../go.opencensus.io/tag/map.go.html#line-146" class="ident">Upsert</a>(<a href="#line-44" class="ident">keyFetchStatus</a>, <a href="../../../../../../pkg/strconv.html" class="ident i4">strconv</a>.<a href="../../../../../strconv/itoa.go.html#line-34" class="ident">Itoa</a>(<label for="r123" class="ident">status</label>)),
	}, <a href="#line-47" class="ident">frontendFetchLatency</a>.<a href="../../../../../go.opencensus.io/stats/measure_float64.go.html#line-25" class="ident">M</a>(<label for="r125" class="ident">l</label>))
</code></pre></div></div>

</div><pre id="footer">
<table><tr><td><img src="../../../../../../png/go101-twitter.png"></td>
<td>The pages are generated with <a href="https://go101.org/article/tool-golds.html"><b>Golds</b></a> <i>v0.3.2-preview</i>. (GOOS=darwin GOARCH=amd64)
<b>Golds</b> is a <a href="https://go101.org">Go 101</a> project developed by <a href="https://tapirgames.com">Tapir Liu</a>.
PR and bug reports are welcome and can be submitted to <a href="https://github.com/go101/golds">the issue list</a>.
Please follow <a href="https://twitter.com/go100and1">@Go100and1</a> (reachable from the left QR code) to get the latest news of <b>Golds</b>.</td></tr></table></pre>