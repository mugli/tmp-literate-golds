<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Source: http.go in package github.com/prometheus/client_golang/prometheus/promhttp</title>
<link href="../../../../../../css/lightLiterate-v0.3.2-preview.css" rel="stylesheet">
<script src="../../../../../../jvs/golds-v0.3.2-preview.js"></script>
<body onload="onPageLoad()"><div>

<pre id="header"><code><span class="title">Source File</span>
	http.go

<span class="title">Belonging Package</span>
	<a href="../../../../../../pkg/github.com/prometheus/client_golang/prometheus/promhttp.html">github.com/prometheus/client_golang/prometheus/promhttp</a>
</code></pre>
<style>input[type=radio] {display: none;}
input[id=r0]:checked ~pre label[for=r0],
input[id=r1]:checked ~pre label[for=r1],
input[id=r2]:checked ~pre label[for=r2],
input[id=r3]:checked ~pre label[for=r3],
input[id=r4]:checked ~pre label[for=r4],
input[id=r5]:checked ~pre label[for=r5],
input[id=r6]:checked ~pre label[for=r6],
input[id=r7]:checked ~pre label[for=r7],
input[id=r8]:checked ~pre label[for=r8],
input[id=r9]:checked ~pre label[for=r9],
input[id=r10]:checked ~pre label[for=r10],
input[id=r11]:checked ~pre label[for=r11],
input[id=r12]:checked ~pre label[for=r12],
input[id=r13]:checked ~pre label[for=r13],
input[id=r14]:checked ~pre label[for=r14],
input[id=r15]:checked ~pre label[for=r15],
input[id=r16]:checked ~pre label[for=r16],
input[id=r17]:checked ~pre label[for=r17],
input[id=r18]:checked ~pre label[for=r18],
input[id=r19]:checked ~pre label[for=r19],
input[id=r20]:checked ~pre label[for=r20],
input[id=r21]:checked ~pre label[for=r21],
input[id=r22]:checked ~pre label[for=r22],
input[id=r23]:checked ~pre label[for=r23],
input[id=r24]:checked ~pre label[for=r24],
input[id=r25]:checked ~pre label[for=r25],
input[id=r26]:checked ~pre label[for=r26],
input[id=r27]:checked ~pre label[for=r27],
input[id=r28]:checked ~pre label[for=r28],
input[id=r29]:checked ~pre label[for=r29],
input[id=r30]:checked ~pre label[for=r30],
input[id=r31]:checked ~pre label[for=r31],
input[id=r32]:checked ~pre label[for=r32],
input[id=r33]:checked ~pre label[for=r33],
input[id=r34]:checked ~pre label[for=r34],
input[id=r35]:checked ~pre label[for=r35],
input[id=r36]:checked ~pre label[for=r36],
input[id=r37]:checked ~pre label[for=r37],
input[id=r38]:checked ~pre label[for=r38],
input[id=r39]:checked ~pre label[for=r39],
input[id=r40]:checked ~pre label[for=r40],
input[id=r41]:checked ~pre label[for=r41],
input[id=r42]:checked ~pre label[for=r42]
{background: #226; color: #ff8;}
input[id=i0]:checked ~pre .i0,
input[id=i1]:checked ~pre .i1,
input[id=i2]:checked ~pre .i2,
input[id=i3]:checked ~pre .i3,
input[id=i4]:checked ~pre .i4,
input[id=i5]:checked ~pre .i5,
input[id=i6]:checked ~pre .i6,
input[id=i7]:checked ~pre .i7,
input[id=i8]:checked ~pre .i8
{background: brown; color: #eed;}
</style><input id="r0" type="radio" name="g"/>
<input id="r1" type="radio" name="g"/>
<input id="r2" type="radio" name="g"/>
<input id="r3" type="radio" name="g"/>
<input id="r4" type="radio" name="g"/>
<input id="r5" type="radio" name="g"/>
<input id="r6" type="radio" name="g"/>
<input id="r7" type="radio" name="g"/>
<input id="r8" type="radio" name="g"/>
<input id="r9" type="radio" name="g"/>
<input id="r10" type="radio" name="g"/>
<input id="r11" type="radio" name="g"/>
<input id="r12" type="radio" name="g"/>
<input id="r13" type="radio" name="g"/>
<input id="r14" type="radio" name="g"/>
<input id="r15" type="radio" name="g"/>
<input id="r16" type="radio" name="g"/>
<input id="r17" type="radio" name="g"/>
<input id="r18" type="radio" name="g"/>
<input id="r19" type="radio" name="g"/>
<input id="r20" type="radio" name="g"/>
<input id="r21" type="radio" name="g"/>
<input id="r22" type="radio" name="g"/>
<input id="r23" type="radio" name="g"/>
<input id="r24" type="radio" name="g"/>
<input id="r25" type="radio" name="g"/>
<input id="r26" type="radio" name="g"/>
<input id="r27" type="radio" name="g"/>
<input id="r28" type="radio" name="g"/>
<input id="r29" type="radio" name="g"/>
<input id="r30" type="radio" name="g"/>
<input id="r31" type="radio" name="g"/>
<input id="r32" type="radio" name="g"/>
<input id="r33" type="radio" name="g"/>
<input id="r34" type="radio" name="g"/>
<input id="r35" type="radio" name="g"/>
<input id="r36" type="radio" name="g"/>
<input id="r37" type="radio" name="g"/>
<input id="r38" type="radio" name="g"/>
<input id="r39" type="radio" name="g"/>
<input id="r40" type="radio" name="g"/>
<input id="r41" type="radio" name="g"/>
<input id="r42" type="radio" name="g"/>
<input id="i0" type="radio" name="i"/>
<input id="i1" type="radio" name="i"/>
<input id="i2" type="radio" name="i"/>
<input id="i3" type="radio" name="i"/>
<input id="i4" type="radio" name="i"/>
<input id="i5" type="radio" name="i"/>
<input id="i6" type="radio" name="i"/>
<input id="i7" type="radio" name="i"/>
<input id="i8" type="radio" name="i"/>
<div id="container"><div class="section">
<div class="doc">
<span class="comment"> Copyright 2016 The Prometheus Authors</span><span class="comment"> Licensed under the Apache License, Version 2.0 (the "License");</span><span class="comment"> you may not use this file except in compliance with the License.</span><span class="comment"> You may obtain a copy of the License at</span><span class="comment"></span><span class="comment"> http://www.apache.org/licenses/LICENSE-2.0</span><span class="comment"></span><span class="comment"> Unless required by applicable law or agreed to in writing, software</span><span class="comment"> distributed under the License is distributed on an "AS IS" BASIS,</span><span class="comment"> WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><span class="comment"> See the License for the specific language governing permissions and</span><span class="comment"> limitations under the License.</span></div>
<div class="code"><pre><code></code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> Package promhttp provides tooling around HTTP servers and clients.</span><span class="comment"></span><span class="comment"> First, the package allows the creation of http.Handler instances to expose</span><span class="comment"> Prometheus metrics via HTTP. promhttp.Handler acts on the</span><span class="comment"> prometheus.DefaultGatherer. With HandlerFor, you can create a handler for a</span><span class="comment"> custom registry or anything that implements the Gatherer interface. It also</span><span class="comment"> allows the creation of handlers that act differently on errors or allow to</span><span class="comment"> log errors.</span><span class="comment"></span><span class="comment"> Second, the package provides tooling to instrument instances of http.Handler</span><span class="comment"> via middleware. Middleware wrappers follow the naming scheme</span><span class="comment"> InstrumentHandlerX, where X describes the intended use of the middleware.</span><span class="comment"> See each function's doc comment for specific details.</span><span class="comment"></span><span class="comment"> Finally, the package allows for an http.RoundTripper to be instrumented via</span><span class="comment"> middleware. Middleware wrappers follow the naming scheme</span><span class="comment"> InstrumentRoundTripperX, where X describes the intended use of the</span><span class="comment"> middleware. See each function's doc comment for specific details.</span></div>
<div class="code"><pre><code><span class="keyword">package</span> promhttp

<span class="keyword">import</span> (
	<label for="i0"><span class="lit-string i0">"compress/gzip"</span></label>
	<label for="i1"><span class="lit-string i1">"fmt"</span></label>
	<label for="i2"><span class="lit-string i2">"io"</span></label>
	<label for="i3"><span class="lit-string i3">"net/http"</span></label>
	<label for="i4"><span class="lit-string i4">"strings"</span></label>
	<label for="i5"><span class="lit-string i5">"sync"</span></label>
	<label for="i6"><span class="lit-string i6">"time"</span></label>

	<label for="i7"><span class="lit-string i7">"github.com/prometheus/common/expfmt"</span></label>

	<label for="i8"><span class="lit-string i8">"github.com/prometheus/client_golang/prometheus"</span></label>
)

<span class="keyword">const</span> (
	<a href="../../../../../../pkg/github.com/prometheus/client_golang/prometheus/promhttp.html#name-contentTypeHeader" class="ident">contentTypeHeader</a>     = <span class="lit-string">"Content-Type"</span>
	<a href="../../../../../../pkg/github.com/prometheus/client_golang/prometheus/promhttp.html#name-contentEncodingHeader" class="ident">contentEncodingHeader</a> = <span class="lit-string">"Content-Encoding"</span>
	<a href="../../../../../../pkg/github.com/prometheus/client_golang/prometheus/promhttp.html#name-acceptEncodingHeader" class="ident">acceptEncodingHeader</a>  = <span class="lit-string">"Accept-Encoding"</span>
)

<span class="keyword">var</span> <a href="../../../../../../pkg/github.com/prometheus/client_golang/prometheus/promhttp.html#name-gzipPool" class="ident">gzipPool</a> = <a href="../../../../../../pkg/sync.html" class="ident i5">sync</a>.<a href="../../../../../sync/pool.go.html#line-44" class="ident">Pool</a>{
	<a href="../../../../../sync/pool.go.html#line-56" class="ident">New</a>: <span class="keyword">func</span>() <span class="keyword">interface</span>{} {
		<span class="keyword">return</span> <a href="../../../../../../pkg/compress/gzip.html" class="ident i0">gzip</a>.<a href="../../../../../compress/gzip/gzip.go.html#line-49" class="ident">NewWriter</a>(<a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a>)
	},
}
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> Handler returns an http.Handler for the prometheus.DefaultGatherer, using</span><span class="comment"> default HandlerOpts, i.e. it reports the first error as an HTTP error, it has</span><span class="comment"> no error logging, and it applies compression if requested by the client.</span><span class="comment"></span><span class="comment"> The returned http.Handler is already instrumented using the</span><span class="comment"> InstrumentMetricHandler function and the prometheus.DefaultRegisterer. If you</span><span class="comment"> create multiple http.Handlers by separate calls of the Handler function, the</span><span class="comment"> metrics used for instrumentation will be shared between them, providing</span><span class="comment"> global scrape counts.</span><span class="comment"></span><span class="comment"> This function is meant to cover the bulk of basic use cases. If you are doing</span><span class="comment"> anything that requires more customization (including using a non-default</span><span class="comment"> Gatherer, different instrumentation, and non-default HandlerOpts), use the</span><span class="comment"> HandlerFor function. See there for details.</span></div>
<div class="code"><pre><code><span class="keyword">func</span> <label for="r0" class="ident"><a href="../../../../../../pkg/github.com/prometheus/client_golang/prometheus/promhttp.html#name-Handler" class="ident">Handler</a></label>() <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/server.go.html#line-86" class="ident">Handler</a> {
	<span class="keyword">return</span> <a href="#line-215" class="ident">InstrumentMetricHandler</a>(
		<a href="../../../../../../pkg/github.com/prometheus/client_golang/prometheus.html" class="ident i8">prometheus</a>.<a href="../registry.go.html#line-56" class="ident">DefaultRegisterer</a>, <a href="#line-86" class="ident">HandlerFor</a>(<a href="../../../../../../pkg/github.com/prometheus/client_golang/prometheus.html" class="ident i8">prometheus</a>.<a href="../registry.go.html#line-57" class="ident">DefaultGatherer</a>, <a href="#line-283" class="ident">HandlerOpts</a>{}),
	)
}
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> HandlerFor returns an uninstrumented http.Handler for the provided</span><span class="comment"> Gatherer. The behavior of the Handler is defined by the provided</span><span class="comment"> HandlerOpts. Thus, HandlerFor is useful to create http.Handlers for custom</span><span class="comment"> Gatherers, with non-default HandlerOpts, and/or with custom (or no)</span><span class="comment"> instrumentation. Use the InstrumentMetricHandler function to apply the same</span><span class="comment"> kind of instrumentation as it is used by the Handler function.</span></div>
<div class="code"><pre><code><span class="keyword">func</span> <label for="r1" class="ident"><a href="../../../../../../pkg/github.com/prometheus/client_golang/prometheus/promhttp.html#name-HandlerFor" class="ident">HandlerFor</a></label>(<label for="r2" class="ident">reg</label> <a href="../../../../../../pkg/github.com/prometheus/client_golang/prometheus.html" class="ident i8">prometheus</a>.<a href="../registry.go.html#line-140" class="ident">Gatherer</a>, <label for="r3" class="ident">opts</label> <a href="#line-283" class="ident">HandlerOpts</a>) <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/server.go.html#line-86" class="ident">Handler</a> {
	<span class="keyword">var</span> (
		<label for="r4" class="ident">inFlightSem</label> <span class="keyword">chan</span> <span class="keyword">struct</span>{}
		<label for="r5" class="ident">errCnt</label>      = <a href="../../../../../../pkg/github.com/prometheus/client_golang/prometheus.html" class="ident i8">prometheus</a>.<a href="../counter.go.html#line-129" class="ident">NewCounterVec</a>(
			<a href="../../../../../../pkg/github.com/prometheus/client_golang/prometheus.html" class="ident i8">prometheus</a>.<a href="../counter.go.html#line-46" class="ident">CounterOpts</a>{
				<a href="../metric.go.html#line-74" class="ident">Name</a>: <span class="lit-string">"promhttp_metric_handler_errors_total"</span>,
				<a href="../metric.go.html#line-80" class="ident">Help</a>: <span class="lit-string">"Total number of internal errors encountered by the promhttp metric handler."</span>,
			},
			[]<a href="../../../../../../pkg/builtin.html#name-string" class="ident">string</a>{<span class="lit-string">"cause"</span>},
		)
	)

	<span class="keyword">if</span> <label for="r3" class="ident">opts</label>.<a href="#line-310" class="ident">MaxRequestsInFlight</a> &gt; <span class="lit-number">0</span> {
		<label for="r4" class="ident">inFlightSem</label> = <a href="../../../../../runtime/chan.go.html#line-71">make</a>(<span class="keyword">chan</span> <span class="keyword">struct</span>{}, <label for="r3" class="ident">opts</label>.<a href="#line-310" class="ident">MaxRequestsInFlight</a>)
	}
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> Initialize all possibilites that can occur below.</span></div>
<div class="code"><pre><code>		<label for="r5" class="ident">errCnt</label>.<a href="../counter.go.html#line-203" class="ident">WithLabelValues</a>(<span class="lit-string">"gathering"</span>)
		<label for="r5" class="ident">errCnt</label>.<a href="../counter.go.html#line-203" class="ident">WithLabelValues</a>(<span class="lit-string">"encoding"</span>)
		<span class="keyword">if</span> <label for="r6" class="ident">err</label> := <label for="r3" class="ident">opts</label>.<a href="#line-302" class="ident">Registry</a>.<a href="../registry.go.html#line-115" class="ident">Register</a>(<label for="r5" class="ident">errCnt</label>); <label for="r6" class="ident">err</label> != <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a> {
			<span class="keyword">if</span> <label for="r7" class="ident">are</label>, <label for="r8" class="ident">ok</label> := <label for="r6" class="ident">err</label>.(<a href="../../../../../../pkg/github.com/prometheus/client_golang/prometheus.html" class="ident i8">prometheus</a>.<a href="../registry.go.html#line-205" class="ident">AlreadyRegisteredError</a>); <label for="r8" class="ident">ok</label> {
				<label for="r5" class="ident">errCnt</label> = <label for="r7" class="ident">are</label>.<a href="../registry.go.html#line-206" class="ident">ExistingCollector</a>.(*<a href="../../../../../../pkg/github.com/prometheus/client_golang/prometheus.html" class="ident i8">prometheus</a>.<a href="../counter.go.html#line-123" class="ident">CounterVec</a>)
			} <span class="keyword">else</span> {
				<a href="../../../../../../pkg/builtin.html#name-panic" class="ident">panic</a>(<label for="r6" class="ident">err</label>)
			}
		}
	}

	<label for="r9" class="ident">h</label> := <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/server.go.html#line-2065" class="ident">HandlerFunc</a>(<span class="keyword">func</span>(<label for="r10" class="ident">rsp</label> <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/server.go.html#line-95" class="ident">ResponseWriter</a>, <label for="r11" class="ident">req</label> *<a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/request.go.html#line-102" class="ident">Request</a>) {
		<span class="keyword">if</span> <label for="r4" class="ident">inFlightSem</label> != <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a> {
			<a href="../../../../../runtime/chan.go.html#line-686"><span class="keyword">select</span></a> {
			<span class="keyword">case</span> <label for="r4" class="ident">inFlightSem</label> <a href="../../../../../runtime/chan.go.html#line-158">&lt;-</a> <span class="keyword">struct</span>{}{}: <span class="comment">// All good, carry on.</span>
				<span class="keyword">defer</span> <span class="keyword">func</span>() { &lt;-<label for="r4" class="ident">inFlightSem</label> }()
			<span class="keyword">default</span>:
				<a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/server.go.html#line-2078" class="ident">Error</a>(<label for="r10" class="ident">rsp</label>, <a href="../../../../../../pkg/fmt.html" class="ident i1">fmt</a>.<a href="../../../../../fmt/print.go.html#line-217" class="ident">Sprintf</a>(
					<span class="lit-string">"Limit of concurrent requests reached (%d), try again later."</span>, <label for="r3" class="ident">opts</label>.<a href="#line-310" class="ident">MaxRequestsInFlight</a>,
				), <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-69" class="ident">StatusServiceUnavailable</a>)
				<span class="keyword">return</span>
			}
		}
		<label for="r12" class="ident">mfs</label>, <label for="r13" class="ident">err</label> := <label for="r2" class="ident">reg</label>.<a href="../registry.go.html#line-160" class="ident">Gather</a>()
		<span class="keyword">if</span> <label for="r13" class="ident">err</label> != <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a> {
			<span class="keyword">if</span> <label for="r3" class="ident">opts</label>.<a href="#line-286" class="ident">ErrorLog</a> != <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a> {
				<label for="r3" class="ident">opts</label>.<a href="#line-286" class="ident">ErrorLog</a>.<a href="#line-278" class="ident">Println</a>(<span class="lit-string">"error gathering metrics:"</span>, <label for="r13" class="ident">err</label>)
			}
			<label for="r5" class="ident">errCnt</label>.<a href="../counter.go.html#line-203" class="ident">WithLabelValues</a>(<span class="lit-string">"gathering"</span>).<a href="../counter.go.html#line-39" class="ident">Inc</a>()
			<span class="keyword">switch</span> <label for="r3" class="ident">opts</label>.<a href="#line-290" class="ident">ErrorHandling</a> {
			<span class="keyword">case</span> <a href="#line-271" class="ident">PanicOnError</a>:
				<a href="../../../../../../pkg/builtin.html#name-panic" class="ident">panic</a>(<label for="r13" class="ident">err</label>)
			<span class="keyword">case</span> <a href="#line-269" class="ident">ContinueOnError</a>:
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> Still report the error if no metrics have been gathered.</span></div>
<div class="code"><pre><code>					<a href="#line-342" class="ident">httpError</a>(<label for="r10" class="ident">rsp</label>, <label for="r13" class="ident">err</label>)
					<span class="keyword">return</span>
				}
			<span class="keyword">case</span> <a href="#line-259" class="ident">HTTPErrorOnError</a>:
				<a href="#line-342" class="ident">httpError</a>(<label for="r10" class="ident">rsp</label>, <label for="r13" class="ident">err</label>)
				<span class="keyword">return</span>
			}
		}

		<label for="r14" class="ident">contentType</label> := <a href="../../../../../../pkg/github.com/prometheus/common/expfmt.html" class="ident i7">expfmt</a>.<a href="../../../common/expfmt/encode.go.html#line-41" class="ident">Negotiate</a>(<label for="r11" class="ident">req</label>.<a href="../../../../../net/http/request.go.html#line-165" class="ident">Header</a>)
		<label for="r15" class="ident">header</label> := <label for="r10" class="ident">rsp</label>.<a href="../../../../../net/http/server.go.html#line-116" class="ident">Header</a>()
		<label for="r15" class="ident">header</label>.<a href="../../../../../net/http/header.go.html#line-36" class="ident">Set</a>(<a href="#line-49" class="ident">contentTypeHeader</a>, <a href="../../../../../../pkg/builtin.html#name-string" class="ident">string</a>(<label for="r14" class="ident">contentType</label>))

		<label for="r16" class="ident">w</label> := <a href="../../../../../../pkg/io.html" class="ident i2">io</a>.<a href="../../../../../io/io.go.html#line-96" class="ident">Writer</a>(<label for="r10" class="ident">rsp</label>)
		<span class="keyword">if</span> !<label for="r3" class="ident">opts</label>.<a href="#line-305" class="ident">DisableCompression</a> &amp;&amp; <a href="#line-324" class="ident">gzipAccepted</a>(<label for="r11" class="ident">req</label>.<a href="../../../../../net/http/request.go.html#line-165" class="ident">Header</a>) {
			<label for="r15" class="ident">header</label>.<a href="../../../../../net/http/header.go.html#line-36" class="ident">Set</a>(<a href="#line-50" class="ident">contentEncodingHeader</a>, <span class="lit-string">"gzip"</span>)
			<label for="r17" class="ident">gz</label> := <a href="#line-54" class="ident">gzipPool</a>.<a href="../../../../../sync/pool.go.html#line-124" class="ident">Get</a>().(*<a href="../../../../../../pkg/compress/gzip.html" class="ident i0">gzip</a>.<a href="../../../../../compress/gzip/gzip.go.html#line-28" class="ident">Writer</a>)
			<span class="keyword">defer</span> <a href="#line-54" class="ident">gzipPool</a>.<a href="../../../../../sync/pool.go.html#line-90" class="ident">Put</a>(<label for="r17" class="ident">gz</label>)

			<label for="r17" class="ident">gz</label>.<a href="../../../../../compress/gzip/gzip.go.html#line-88" class="ident">Reset</a>(<label for="r16" class="ident">w</label>)
			<span class="keyword">defer</span> <label for="r17" class="ident">gz</label>.<a href="../../../../../compress/gzip/gzip.go.html#line-228" class="ident">Close</a>()

			<label for="r16" class="ident">w</label> = <label for="r17" class="ident">gz</label>
		}

		<label for="r18" class="ident">enc</label> := <a href="../../../../../../pkg/github.com/prometheus/common/expfmt.html" class="ident i7">expfmt</a>.<a href="../../../common/expfmt/encode.go.html#line-64" class="ident">NewEncoder</a>(<label for="r16" class="ident">w</label>, <label for="r14" class="ident">contentType</label>)

		<span class="keyword">var</span> <label for="r19" class="ident">lastErr</label> <a href="../../../../../../pkg/builtin.html#name-error" class="ident">error</a>
		<span class="keyword">for</span> <label for="r20" class="ident">_</label>, <label for="r21" class="ident">mf</label> := <span class="keyword">range</span> <label for="r12" class="ident">mfs</label> {
			<span class="keyword">if</span> <label for="r22" class="ident">err</label> := <label for="r18" class="ident">enc</label>.<a href="../../../common/expfmt/encode.go.html#line-30" class="ident">Encode</a>(<label for="r21" class="ident">mf</label>); <label for="r22" class="ident">err</label> != <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a> {
				<label for="r19" class="ident">lastErr</label> = <label for="r22" class="ident">err</label>
				<span class="keyword">if</span> <label for="r3" class="ident">opts</label>.<a href="#line-286" class="ident">ErrorLog</a> != <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a> {
					<label for="r3" class="ident">opts</label>.<a href="#line-286" class="ident">ErrorLog</a>.<a href="#line-278" class="ident">Println</a>(<span class="lit-string">"error encoding and sending metric family:"</span>, <label for="r22" class="ident">err</label>)
				}
				<label for="r5" class="ident">errCnt</label>.<a href="../counter.go.html#line-203" class="ident">WithLabelValues</a>(<span class="lit-string">"encoding"</span>).<a href="../counter.go.html#line-39" class="ident">Inc</a>()
				<span class="keyword">switch</span> <label for="r3" class="ident">opts</label>.<a href="#line-290" class="ident">ErrorHandling</a> {
				<span class="keyword">case</span> <a href="#line-271" class="ident">PanicOnError</a>:
					<a href="../../../../../../pkg/builtin.html#name-panic" class="ident">panic</a>(<label for="r22" class="ident">err</label>)
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> Handled later.</span></div>
<div class="code"><pre><code>				<span class="keyword">case</span> <a href="#line-259" class="ident">HTTPErrorOnError</a>:
					<a href="#line-342" class="ident">httpError</a>(<label for="r10" class="ident">rsp</label>, <label for="r22" class="ident">err</label>)
					<span class="keyword">return</span>
				}
			}
		}

		<span class="keyword">if</span> <label for="r19" class="ident">lastErr</label> != <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a> {
			<a href="#line-342" class="ident">httpError</a>(<label for="r10" class="ident">rsp</label>, <label for="r19" class="ident">lastErr</label>)
		}
	})

	<span class="keyword">if</span> <label for="r3" class="ident">opts</label>.<a href="#line-320" class="ident">Timeout</a> &lt;= <span class="lit-number">0</span> {
		<span class="keyword">return</span> <label for="r9" class="ident">h</label>
	}
	<span class="keyword">return</span> <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/server.go.html#line-3266" class="ident">TimeoutHandler</a>(<label for="r9" class="ident">h</label>, <label for="r3" class="ident">opts</label>.<a href="#line-320" class="ident">Timeout</a>, <a href="../../../../../../pkg/fmt.html" class="ident i1">fmt</a>.<a href="../../../../../fmt/print.go.html#line-217" class="ident">Sprintf</a>(
		<span class="lit-string">"Exceeded configured timeout of %v.\n"</span>,
		<label for="r3" class="ident">opts</label>.<a href="#line-320" class="ident">Timeout</a>,
	))
}
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> InstrumentMetricHandler is usually used with an http.Handler returned by the</span><span class="comment"> HandlerFor function. It instruments the provided http.Handler with two</span><span class="comment"> metrics: A counter vector "promhttp_metric_handler_requests_total" to count</span><span class="comment"> scrapes partitioned by HTTP status code, and a gauge</span><span class="comment"> "promhttp_metric_handler_requests_in_flight" to track the number of</span><span class="comment"> simultaneous scrapes. This function idempotently registers collectors for</span><span class="comment"> both metrics with the provided Registerer. It panics if the registration</span><span class="comment"> fails. The provided metrics are useful to see how many scrapes hit the</span><span class="comment"> monitored target (which could be from different Prometheus servers or other</span><span class="comment"> scrapers), and how often they overlap (which would result in more than one</span><span class="comment"> scrape in flight at the same time). Note that the scrapes-in-flight gauge</span><span class="comment"> will contain the scrape by which it is exposed, while the scrape counter will</span><span class="comment"> only get incremented after the scrape is complete (as only then the status</span><span class="comment"> code is known). For tracking scrape durations, use the</span><span class="comment"> "scrape_duration_seconds" gauge created by the Prometheus server upon each</span><span class="comment"> scrape.</span></div>
<div class="code"><pre><code><span class="keyword">func</span> <label for="r23" class="ident"><a href="../../../../../../pkg/github.com/prometheus/client_golang/prometheus/promhttp.html#name-InstrumentMetricHandler" class="ident">InstrumentMetricHandler</a></label>(<label for="r24" class="ident">reg</label> <a href="../../../../../../pkg/github.com/prometheus/client_golang/prometheus.html" class="ident i8">prometheus</a>.<a href="../registry.go.html#line-96" class="ident">Registerer</a>, <label for="r25" class="ident">handler</label> <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/server.go.html#line-86" class="ident">Handler</a>) <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/server.go.html#line-86" class="ident">Handler</a> {
	<label for="r26" class="ident">cnt</label> := <a href="../../../../../../pkg/github.com/prometheus/client_golang/prometheus.html" class="ident i8">prometheus</a>.<a href="../counter.go.html#line-129" class="ident">NewCounterVec</a>(
		<a href="../../../../../../pkg/github.com/prometheus/client_golang/prometheus.html" class="ident i8">prometheus</a>.<a href="../counter.go.html#line-46" class="ident">CounterOpts</a>{
			<a href="../metric.go.html#line-74" class="ident">Name</a>: <span class="lit-string">"promhttp_metric_handler_requests_total"</span>,
			<a href="../metric.go.html#line-80" class="ident">Help</a>: <span class="lit-string">"Total number of scrapes by HTTP status code."</span>,
		},
		[]<a href="../../../../../../pkg/builtin.html#name-string" class="ident">string</a>{<span class="lit-string">"code"</span>},
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> Initialize the most likely HTTP status codes.</span></div>
<div class="code"><pre><code>	<label for="r26" class="ident">cnt</label>.<a href="../counter.go.html#line-203" class="ident">WithLabelValues</a>(<span class="lit-string">"200"</span>)
	<label for="r26" class="ident">cnt</label>.<a href="../counter.go.html#line-203" class="ident">WithLabelValues</a>(<span class="lit-string">"500"</span>)
	<label for="r26" class="ident">cnt</label>.<a href="../counter.go.html#line-203" class="ident">WithLabelValues</a>(<span class="lit-string">"503"</span>)
	<span class="keyword">if</span> <label for="r27" class="ident">err</label> := <label for="r24" class="ident">reg</label>.<a href="../registry.go.html#line-115" class="ident">Register</a>(<label for="r26" class="ident">cnt</label>); <label for="r27" class="ident">err</label> != <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a> {
		<span class="keyword">if</span> <label for="r28" class="ident">are</label>, <label for="r29" class="ident">ok</label> := <label for="r27" class="ident">err</label>.(<a href="../../../../../../pkg/github.com/prometheus/client_golang/prometheus.html" class="ident i8">prometheus</a>.<a href="../registry.go.html#line-205" class="ident">AlreadyRegisteredError</a>); <label for="r29" class="ident">ok</label> {
			<label for="r26" class="ident">cnt</label> = <label for="r28" class="ident">are</label>.<a href="../registry.go.html#line-206" class="ident">ExistingCollector</a>.(*<a href="../../../../../../pkg/github.com/prometheus/client_golang/prometheus.html" class="ident i8">prometheus</a>.<a href="../counter.go.html#line-123" class="ident">CounterVec</a>)
		} <span class="keyword">else</span> {
			<a href="../../../../../../pkg/builtin.html#name-panic" class="ident">panic</a>(<label for="r27" class="ident">err</label>)
		}
	}

	<label for="r30" class="ident">gge</label> := <a href="../../../../../../pkg/github.com/prometheus/client_golang/prometheus.html" class="ident i8">prometheus</a>.<a href="../gauge.go.html#line-66" class="ident">NewGauge</a>(<a href="../../../../../../pkg/github.com/prometheus/client_golang/prometheus.html" class="ident i8">prometheus</a>.<a href="../gauge.go.html#line-56" class="ident">GaugeOpts</a>{
		<a href="../metric.go.html#line-74" class="ident">Name</a>: <span class="lit-string">"promhttp_metric_handler_requests_in_flight"</span>,
		<a href="../metric.go.html#line-80" class="ident">Help</a>: <span class="lit-string">"Current number of scrapes being served."</span>,
	})
	<span class="keyword">if</span> <label for="r31" class="ident">err</label> := <label for="r24" class="ident">reg</label>.<a href="../registry.go.html#line-115" class="ident">Register</a>(<label for="r30" class="ident">gge</label>); <label for="r31" class="ident">err</label> != <a href="../../../../../../pkg/builtin.html#name-nil" class="ident">nil</a> {
		<span class="keyword">if</span> <label for="r32" class="ident">are</label>, <label for="r33" class="ident">ok</label> := <label for="r31" class="ident">err</label>.(<a href="../../../../../../pkg/github.com/prometheus/client_golang/prometheus.html" class="ident i8">prometheus</a>.<a href="../registry.go.html#line-205" class="ident">AlreadyRegisteredError</a>); <label for="r33" class="ident">ok</label> {
			<label for="r30" class="ident">gge</label> = <label for="r32" class="ident">are</label>.<a href="../registry.go.html#line-206" class="ident">ExistingCollector</a>.(<a href="../../../../../../pkg/github.com/prometheus/client_golang/prometheus.html" class="ident i8">prometheus</a>.<a href="../gauge.go.html#line-32" class="ident">Gauge</a>)
		} <span class="keyword">else</span> {
			<a href="../../../../../../pkg/builtin.html#name-panic" class="ident">panic</a>(<label for="r31" class="ident">err</label>)
		}
	}

	<span class="keyword">return</span> <a href="instrument_server.go.html#line-94" class="ident">InstrumentHandlerCounter</a>(<label for="r26" class="ident">cnt</label>, <a href="instrument_server.go.html#line-36" class="ident">InstrumentHandlerInFlight</a>(<label for="r30" class="ident">gge</label>, <label for="r25" class="ident">handler</label>))
}
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> HandlerErrorHandling defines how a Handler serving metrics will handle</span><span class="comment"> errors.</span></div>
<div class="code"><pre><code><span class="keyword">type</span> <a href="../../../../../../pkg/github.com/prometheus/client_golang/prometheus/promhttp.html#name-HandlerErrorHandling" class="ident">HandlerErrorHandling</a> <a href="../../../../../../pkg/builtin.html#name-int" class="ident">int</a>
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> These constants cause handlers serving metrics to behave as described if</span><span class="comment"> errors are encountered.</span></div>
<div class="code"><pre><code></code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> Serve an HTTP status code 500 upon the first error</span><span class="comment">	 encountered. Report the error message in the body.</span></div>
<div class="code"><pre><code></code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> Ignore errors and try to serve as many metrics as possible.  However,</span><span class="comment">	 if no metrics can be served, serve an HTTP status code 500 and the</span><span class="comment">	 last error message in the body. Only use this in deliberate "best</span><span class="comment">	 effort" metrics collection scenarios. In this case, it is highly</span><span class="comment">	 recommended to provide other means of detecting errors: By setting an</span><span class="comment">	 ErrorLog in HandlerOpts, the errors are logged. By providing a</span><span class="comment">	 Registry in HandlerOpts, the exposed metrics include an error counter</span><span class="comment">	 "promhttp_metric_handler_errors_total", which can be used for</span><span class="comment">	 alerts.</span></div>
<div class="code"><pre><code></code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> Panic upon the first error encountered (useful for "crash only" apps).</span></div>
<div class="code"><pre><code>	<a href="../../../../../../pkg/github.com/prometheus/client_golang/prometheus/promhttp.html#name-PanicOnError" class="ident">PanicOnError</a>
)
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> Logger is the minimal interface HandlerOpts needs for logging. Note that</span><span class="comment"> log.Logger from the standard library implements this interface, and it is</span><span class="comment"> easy to implement by custom loggers, if they don't do so already anyway.</span></div>
<div class="code"><pre><code><span class="keyword">type</span> <a href="../../../../../../pkg/github.com/prometheus/client_golang/prometheus/promhttp.html#name-Logger" class="ident">Logger</a> <span class="keyword">interface</span> {
	Println(v ...<span class="keyword">interface</span>{})
}
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> HandlerOpts specifies options how to serve metrics via an http.Handler. The</span><span class="comment"> zero value of HandlerOpts is a reasonable default.</span></div>
<div class="code"><pre><code></code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> ErrorLog specifies an optional logger for errors collecting and</span><span class="comment">	 serving metrics. If nil, errors are not logged at all.</span></div>
<div class="code"><pre><code></code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> ErrorHandling defines how errors are handled. Note that errors are</span><span class="comment">	 logged regardless of the configured ErrorHandling provided ErrorLog</span><span class="comment">	 is not nil.</span></div>
<div class="code"><pre><code></code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> If Registry is not nil, it is used to register a metric</span><span class="comment">	 "promhttp_metric_handler_errors_total", partitioned by "cause". A</span><span class="comment">	 failed registration causes a panic. Note that this error counter is</span><span class="comment">	 different from the instrumentation you get from the various</span><span class="comment">	 InstrumentHandler... helpers. It counts errors that don't necessarily</span><span class="comment">	 result in a non-2xx HTTP status code. There are two typical cases:</span><span class="comment">	 (1) Encoding errors that only happen after streaming of the HTTP body</span><span class="comment">	 has already started (and the status code 200 has been sent). This</span><span class="comment">	 should only happen with custom collectors. (2) Collection errors with</span><span class="comment">	 no effect on the HTTP status code because ErrorHandling is set to</span><span class="comment">	 ContinueOnError.</span></div>
<div class="code"><pre><code></code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> If DisableCompression is true, the handler will never compress the</span><span class="comment">	 response, even if requested by the client.</span></div>
<div class="code"><pre><code></code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> The number of concurrent HTTP requests is limited to</span><span class="comment">	 MaxRequestsInFlight. Additional requests are responded to with 503</span><span class="comment">	 Service Unavailable and a suitable message in the body. If</span><span class="comment">	 MaxRequestsInFlight is 0 or negative, no limit is applied.</span></div>
<div class="code"><pre><code></code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> If handling a request takes longer than Timeout, it is responded to</span><span class="comment">	 with 503 ServiceUnavailable and a suitable Message. No timeout is</span><span class="comment">	 applied if Timeout is 0 or negative. Note that with the current</span><span class="comment">	 implementation, reaching the timeout simply ends the HTTP requests as</span><span class="comment">	 described above (and even that only if sending of the body hasn't</span><span class="comment">	 started yet), while the bulk work of gathering all the metrics keeps</span><span class="comment">	 running in the background (with the eventual result to be thrown</span><span class="comment">	 away). Until the implementation is improved, it is recommended to</span><span class="comment">	 implement a separate timeout in potentially slow Collectors.</span></div>
<div class="code"><pre><code>	<a href="../../../../../../use/github.com/prometheus/client_golang/prometheus/promhttp..HandlerOpts.Timeout.html" class="ident">Timeout</a> <a href="../../../../../../pkg/time.html" class="ident i6">time</a>.<a href="../../../../../time/time.go.html#line-583" class="ident">Duration</a>
}
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> gzipAccepted returns whether the client will accept gzip-encoded content.</span></div>
<div class="code"><pre><code><span class="keyword">func</span> <label for="r34" class="ident"><a href="../../../../../../pkg/github.com/prometheus/client_golang/prometheus/promhttp.html#name-gzipAccepted" class="ident">gzipAccepted</a></label>(<label for="r35" class="ident">header</label> <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/header.go.html#line-21" class="ident">Header</a>) <a href="../../../../../../pkg/builtin.html#name-bool" class="ident">bool</a> {
	<label for="r36" class="ident">a</label> := <label for="r35" class="ident">header</label>.<a href="../../../../../net/http/header.go.html#line-45" class="ident">Get</a>(<a href="#line-51" class="ident">acceptEncodingHeader</a>)
	<label for="r37" class="ident">parts</label> := <a href="../../../../../../pkg/strings.html" class="ident i4">strings</a>.<a href="../../../../../strings/strings.go.html#line-299" class="ident">Split</a>(<label for="r36" class="ident">a</label>, <span class="lit-string">","</span>)
	<span class="keyword">for</span> <label for="r38" class="ident">_</label>, <label for="r39" class="ident">part</label> := <span class="keyword">range</span> <label for="r37" class="ident">parts</label> {
		<label for="r39" class="ident">part</label> = <a href="../../../../../../pkg/strings.html" class="ident i4">strings</a>.<a href="../../../../../strings/strings.go.html#line-867" class="ident">TrimSpace</a>(<label for="r39" class="ident">part</label>)
		<span class="keyword">if</span> <label for="r39" class="ident">part</label> == <span class="lit-string">"gzip"</span> || <a href="../../../../../../pkg/strings.html" class="ident i4">strings</a>.<a href="../../../../../strings/strings.go.html#line-444" class="ident">HasPrefix</a>(<label for="r39" class="ident">part</label>, <span class="lit-string">"gzip;"</span>) {
			<span class="keyword">return</span> <a href="../../../../../../pkg/builtin.html#name-true" class="ident">true</a>
		}
	}
	<span class="keyword">return</span> <a href="../../../../../../pkg/builtin.html#name-false" class="ident">false</a>
}
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> httpError removes any content-encoding header and then calls http.Error with</span><span class="comment"> the provided error and http.StatusInternalServerErrer. Error contents is</span><span class="comment"> supposed to be uncompressed plain text. However, same as with a plain</span><span class="comment"> http.Error, any header settings will be void if the header has already been</span><span class="comment"> sent. The error message will still be written to the writer, but it will</span><span class="comment"> probably be of limited use.</span></div>
<div class="code"><pre><code><span class="keyword">func</span> <label for="r40" class="ident"><a href="../../../../../../pkg/github.com/prometheus/client_golang/prometheus/promhttp.html#name-httpError" class="ident">httpError</a></label>(<label for="r41" class="ident">rsp</label> <a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/server.go.html#line-95" class="ident">ResponseWriter</a>, <label for="r42" class="ident">err</label> <a href="../../../../../../pkg/builtin.html#name-error" class="ident">error</a>) {
	<label for="r41" class="ident">rsp</label>.<a href="../../../../../net/http/server.go.html#line-116" class="ident">Header</a>().<a href="../../../../../net/http/header.go.html#line-76" class="ident">Del</a>(<a href="#line-50" class="ident">contentEncodingHeader</a>)
	<a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/server.go.html#line-2078" class="ident">Error</a>(
		<label for="r41" class="ident">rsp</label>,
		<span class="lit-string">"An error has occurred while serving metrics:\n\n"</span>+<label for="r42" class="ident">err</label>.Error(),
		<a href="../../../../../../pkg/net/http.html" class="ident i3">http</a>.<a href="../../../../../net/http/status.go.html#line-66" class="ident">StatusInternalServerError</a>,
	)
</code></pre></div></div>

</div><pre id="footer">
<table><tr><td><img src="../../../../../../png/go101-twitter.png"></td>
<td>The pages are generated with <a href="https://go101.org/article/tool-golds.html"><b>Golds</b></a> <i>v0.3.2-preview</i>. (GOOS=darwin GOARCH=amd64)
<b>Golds</b> is a <a href="https://go101.org">Go 101</a> project developed by <a href="https://tapirgames.com">Tapir Liu</a>.
PR and bug reports are welcome and can be submitted to <a href="https://github.com/go101/golds">the issue list</a>.
Please follow <a href="https://twitter.com/go100and1">@Go100and1</a> (reachable from the left QR code) to get the latest news of <b>Golds</b>.</td></tr></table></pre>