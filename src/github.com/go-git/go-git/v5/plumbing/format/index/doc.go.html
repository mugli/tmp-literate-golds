<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Source: doc.go in package github.com/go-git/go-git/v5/plumbing/format/index</title>
<link href="../../../../../../../../css/lightLiterate-v0.3.2-preview.css" rel="stylesheet">
<script src="../../../../../../../../jvs/golds-v0.3.2-preview.js"></script>
<body onload="onPageLoad()"><div>

<pre id="header"><code><span class="title">Source File</span>
	doc.go

<span class="title">Belonging Package</span>
	<a href="../../../../../../../../pkg/github.com/go-git/go-git/v5/plumbing/format/index.html">github.com/go-git/go-git/v5/plumbing/format/index</a>
</code></pre>
<div id="container"><div class="section">
<div class="doc">
<span class="comment"> Package index implements encoding and decoding of index format files.</span><span class="comment"></span><span class="comment">    Git index format</span><span class="comment">    ================</span><span class="comment"></span><span class="comment">    == The Git index file has the following format</span><span class="comment"></span><span class="comment">      All binary numbers are in network byte order. Version 2 is described</span><span class="comment">      here unless stated otherwise.</span><span class="comment"></span><span class="comment">      - A 12-byte header consisting of</span><span class="comment"></span><span class="comment">        4-byte signature:</span><span class="comment">          The signature is { 'D', 'I', 'R', 'C' } (stands for "dircache")</span><span class="comment"></span><span class="comment">        4-byte version number:</span><span class="comment">          The current supported versions are 2, 3 and 4.</span><span class="comment"></span><span class="comment">        32-bit number of index entries.</span><span class="comment"></span><span class="comment">      - A number of sorted index entries (see below).</span><span class="comment"></span><span class="comment">      - Extensions</span><span class="comment"></span><span class="comment">        Extensions are identified by signature. Optional extensions can</span><span class="comment">        be ignored if Git does not understand them.</span><span class="comment"></span><span class="comment">        Git currently supports cached tree and resolve undo extensions.</span><span class="comment"></span><span class="comment">        4-byte extension signature. If the first byte is 'A'..'Z' the</span><span class="comment">        extension is optional and can be ignored.</span><span class="comment"></span><span class="comment">        32-bit size of the extension</span><span class="comment"></span><span class="comment">        Extension data</span><span class="comment"></span><span class="comment">      - 160-bit SHA-1 over the content of the index file before this</span><span class="comment">        checksum.</span><span class="comment"></span><span class="comment">    == Index entry</span><span class="comment"></span><span class="comment">      Index entries are sorted in ascending order on the name field,</span><span class="comment">      interpreted as a string of unsigned bytes (i.e. memcmp() order, no</span><span class="comment">      localization, no special casing of directory separator '/'). Entries</span><span class="comment">      with the same name are sorted by their stage field.</span><span class="comment"></span><span class="comment">      32-bit ctime seconds, the last time a file's metadata changed</span><span class="comment">        this is stat(2) data</span><span class="comment"></span><span class="comment">      32-bit ctime nanosecond fractions</span><span class="comment">        this is stat(2) data</span><span class="comment"></span><span class="comment">      32-bit mtime seconds, the last time a file's data changed</span><span class="comment">        this is stat(2) data</span><span class="comment"></span><span class="comment">      32-bit mtime nanosecond fractions</span><span class="comment">        this is stat(2) data</span><span class="comment"></span><span class="comment">      32-bit dev</span><span class="comment">        this is stat(2) data</span><span class="comment"></span><span class="comment">      32-bit ino</span><span class="comment">        this is stat(2) data</span><span class="comment"></span><span class="comment">      32-bit mode, split into (high to low bits)</span><span class="comment"></span><span class="comment">        4-bit object type</span><span class="comment">          valid values in binary are 1000 (regular file), 1010 (symbolic link)</span><span class="comment">          and 1110 (gitlink)</span><span class="comment"></span><span class="comment">        3-bit unused</span><span class="comment"></span><span class="comment">        9-bit unix permission. Only 0755 and 0644 are valid for regular files.</span><span class="comment">        Symbolic links and gitlinks have value 0 in this field.</span><span class="comment"></span><span class="comment">      32-bit uid</span><span class="comment">        this is stat(2) data</span><span class="comment"></span><span class="comment">      32-bit gid</span><span class="comment">        this is stat(2) data</span><span class="comment"></span><span class="comment">      32-bit file size</span><span class="comment">        This is the on-disk size from stat(2), truncated to 32-bit.</span><span class="comment"></span><span class="comment">      160-bit SHA-1 for the represented object</span><span class="comment"></span><span class="comment">      A 16-bit 'flags' field split into (high to low bits)</span><span class="comment"></span><span class="comment">        1-bit assume-valid flag</span><span class="comment"></span><span class="comment">        1-bit extended flag (must be zero in version 2)</span><span class="comment"></span><span class="comment">        2-bit stage (during merge)</span><span class="comment"></span><span class="comment">        12-bit name length if the length is less than 0xFFF; otherwise 0xFFF</span><span class="comment">        is stored in this field.</span><span class="comment"></span><span class="comment">      (Version 3 or later) A 16-bit field, only applicable if the</span><span class="comment">      "extended flag" above is 1, split into (high to low bits).</span><span class="comment"></span><span class="comment">        1-bit reserved for future</span><span class="comment"></span><span class="comment">        1-bit skip-worktree flag (used by sparse checkout)</span><span class="comment"></span><span class="comment">        1-bit intent-to-add flag (used by "git add -N")</span><span class="comment"></span><span class="comment">        13-bit unused, must be zero</span><span class="comment"></span><span class="comment">      Entry path name (variable length) relative to top level directory</span><span class="comment">        (without leading slash). '/' is used as path separator. The special</span><span class="comment">        path components ".", ".." and ".git" (without quotes) are disallowed.</span><span class="comment">        Trailing slash is also disallowed.</span><span class="comment"></span><span class="comment">        The exact encoding is undefined, but the '.' and '/' characters</span><span class="comment">        are encoded in 7-bit ASCII and the encoding cannot contain a NUL</span><span class="comment">        byte (iow, this is a UNIX pathname).</span><span class="comment"></span><span class="comment">      (Version 4) In version 4, the entry path name is prefix-compressed</span><span class="comment">        relative to the path name for the previous entry (the very first</span><span class="comment">        entry is encoded as if the path name for the previous entry is an</span><span class="comment">        empty string).  At the beginning of an entry, an integer N in the</span><span class="comment">        variable width encoding (the same encoding as the offset is encoded</span><span class="comment">        for OFS_DELTA pack entries; see pack-format.txt) is stored, followed</span><span class="comment">        by a NUL-terminated string S.  Removing N bytes from the end of the</span><span class="comment">        path name for the previous entry, and replacing it with the string S</span><span class="comment">        yields the path name for this entry.</span><span class="comment"></span><span class="comment">      1-8 nul bytes as necessary to pad the entry to a multiple of eight bytes</span><span class="comment">      while keeping the name NUL-terminated.</span><span class="comment"></span><span class="comment">      (Version 4) In version 4, the padding after the pathname does not</span><span class="comment">      exist.</span><span class="comment"></span><span class="comment">      Interpretation of index entries in split index mode is completely</span><span class="comment">      different. See below for details.</span><span class="comment"></span><span class="comment">    == Extensions</span><span class="comment"></span><span class="comment">    === Cached tree</span><span class="comment"></span><span class="comment">      Cached tree extension contains pre-computed hashes for trees that can</span><span class="comment">      be derived from the index. It helps speed up tree object generation</span><span class="comment">      from index for a new commit.</span><span class="comment"></span><span class="comment">      When a path is updated in index, the path must be invalidated and</span><span class="comment">      removed from tree cache.</span><span class="comment"></span><span class="comment">      The signature for this extension is { 'T', 'R', 'E', 'E' }.</span><span class="comment"></span><span class="comment">      A series of entries fill the entire extension; each of which</span><span class="comment">      consists of:</span><span class="comment"></span><span class="comment">      - NUL-terminated path component (relative to its parent directory);</span><span class="comment"></span><span class="comment">      - ASCII decimal number of entries in the index that is covered by the</span><span class="comment">        tree this entry represents (entry_count);</span><span class="comment"></span><span class="comment">      - A space (ASCII 32);</span><span class="comment"></span><span class="comment">      - ASCII decimal number that represents the number of subtrees this</span><span class="comment">        tree has;</span><span class="comment"></span><span class="comment">      - A newline (ASCII 10); and</span><span class="comment"></span><span class="comment">      - 160-bit object name for the object that would result from writing</span><span class="comment">        this span of index as a tree.</span><span class="comment"></span><span class="comment">      An entry can be in an invalidated state and is represented by having</span><span class="comment">      a negative number in the entry_count field. In this case, there is no</span><span class="comment">      object name and the next entry starts immediately after the newline.</span><span class="comment">      When writing an invalid entry, -1 should always be used as entry_count.</span><span class="comment"></span><span class="comment">      The entries are written out in the top-down, depth-first order.  The</span><span class="comment">      first entry represents the root level of the repository, followed by the</span><span class="comment">      first subtree--let's call this A--of the root level (with its name</span><span class="comment">      relative to the root level), followed by the first subtree of A (with</span><span class="comment">      its name relative to A), ...</span><span class="comment"></span><span class="comment">    === Resolve undo</span><span class="comment"></span><span class="comment">      A conflict is represented in the index as a set of higher stage entries.</span><span class="comment">      When a conflict is resolved (e.g. with "git add path"), these higher</span><span class="comment">      stage entries will be removed and a stage-0 entry with proper resolution</span><span class="comment">      is added.</span><span class="comment"></span><span class="comment">      When these higher stage entries are removed, they are saved in the</span><span class="comment">      resolve undo extension, so that conflicts can be recreated (e.g. with</span><span class="comment">      "git checkout -m"), in case users want to redo a conflict resolution</span><span class="comment">      from scratch.</span><span class="comment"></span><span class="comment">      The signature for this extension is { 'R', 'E', 'U', 'C' }.</span><span class="comment"></span><span class="comment">      A series of entries fill the entire extension; each of which</span><span class="comment">      consists of:</span><span class="comment"></span><span class="comment">      - NUL-terminated pathname the entry describes (relative to the root of</span><span class="comment">        the repository, i.e. full pathname);</span><span class="comment"></span><span class="comment">      - Three NUL-terminated ASCII octal numbers, entry mode of entries in</span><span class="comment">        stage 1 to 3 (a missing stage is represented by "0" in this field);</span><span class="comment">        and</span><span class="comment"></span><span class="comment">      - At most three 160-bit object names of the entry in stages from 1 to 3</span><span class="comment">        (nothing is written for a missing stage).</span><span class="comment"></span><span class="comment">    === Split index</span><span class="comment"></span><span class="comment">      In split index mode, the majority of index entries could be stored</span><span class="comment">      in a separate file. This extension records the changes to be made on</span><span class="comment">      top of that to produce the final index.</span><span class="comment"></span><span class="comment">      The signature for this extension is { 'l', 'i', 'n', 'k' }.</span><span class="comment"></span><span class="comment">      The extension consists of:</span><span class="comment"></span><span class="comment">      - 160-bit SHA-1 of the shared index file. The shared index file path</span><span class="comment">        is $GIT_DIR/sharedindex.&lt;SHA-1&gt;. If all 160 bits are zero, the</span><span class="comment">        index does not require a shared index file.</span><span class="comment"></span><span class="comment">      - An ewah-encoded delete bitmap, each bit represents an entry in the</span><span class="comment">        shared index. If a bit is set, its corresponding entry in the</span><span class="comment">        shared index will be removed from the final index.  Note, because</span><span class="comment">        a delete operation changes index entry positions, but we do need</span><span class="comment">        original positions in replace phase, it's best to just mark</span><span class="comment">        entries for removal, then do a mass deletion after replacement.</span><span class="comment"></span><span class="comment">      - An ewah-encoded replace bitmap, each bit represents an entry in</span><span class="comment">        the shared index. If a bit is set, its corresponding entry in the</span><span class="comment">        shared index will be replaced with an entry in this index</span><span class="comment">        file. All replaced entries are stored in sorted order in this</span><span class="comment">        index. The first "1" bit in the replace bitmap corresponds to the</span><span class="comment">        first index entry, the second "1" bit to the second entry and so</span><span class="comment">        on. Replaced entries may have empty path names to save space.</span><span class="comment"></span><span class="comment">      The remaining index entries after replaced ones will be added to the</span><span class="comment">      final index. These added entries are also sorted by entry name then</span><span class="comment">      stage.</span><span class="comment"></span><span class="comment">    == Untracked cache</span><span class="comment"></span><span class="comment">      Untracked cache saves the untracked file list and necessary data to</span><span class="comment">      verify the cache. The signature for this extension is { 'U', 'N',</span><span class="comment">      'T', 'R' }.</span><span class="comment"></span><span class="comment">      The extension starts with</span><span class="comment"></span><span class="comment">      - A sequence of NUL-terminated strings, preceded by the size of the</span><span class="comment">        sequence in variable width encoding. Each string describes the</span><span class="comment">        environment where the cache can be used.</span><span class="comment"></span><span class="comment">      - Stat data of $GIT_DIR/info/exclude. See "Index entry" section from</span><span class="comment">        ctime field until "file size".</span><span class="comment"></span><span class="comment">      - Stat data of plumbing.excludesfile</span><span class="comment"></span><span class="comment">      - 32-bit dir_flags (see struct dir_struct)</span><span class="comment"></span><span class="comment">      - 160-bit SHA-1 of $GIT_DIR/info/exclude. Null SHA-1 means the file</span><span class="comment">        does not exist.</span><span class="comment"></span><span class="comment">      - 160-bit SHA-1 of plumbing.excludesfile. Null SHA-1 means the file does</span><span class="comment">        not exist.</span><span class="comment"></span><span class="comment">      - NUL-terminated string of per-dir exclude file name. This usually</span><span class="comment">        is ".gitignore".</span><span class="comment"></span><span class="comment">      - The number of following directory blocks, variable width</span><span class="comment">        encoding. If this number is zero, the extension ends here with a</span><span class="comment">        following NUL.</span><span class="comment"></span><span class="comment">      - A number of directory blocks in depth-first-search order, each</span><span class="comment">        consists of</span><span class="comment"></span><span class="comment">        - The number of untracked entries, variable width encoding.</span><span class="comment"></span><span class="comment">        - The number of sub-directory blocks, variable width encoding.</span><span class="comment"></span><span class="comment">        - The directory name terminated by NUL.</span><span class="comment"></span><span class="comment">        - A number of untracked file/dir names terminated by NUL.</span><span class="comment"></span><span class="comment">    The remaining data of each directory block is grouped by type:</span><span class="comment"></span><span class="comment">      - An ewah bitmap, the n-th bit marks whether the n-th directory has</span><span class="comment">        valid untracked cache entries.</span><span class="comment"></span><span class="comment">      - An ewah bitmap, the n-th bit records "check-only" bit of</span><span class="comment">        read_directory_recursive() for the n-th directory.</span><span class="comment"></span><span class="comment">      - An ewah bitmap, the n-th bit indicates whether SHA-1 and stat data</span><span class="comment">        is valid for the n-th directory and exists in the next data.</span><span class="comment"></span><span class="comment">      - An array of stat data. The n-th data corresponds with the n-th</span><span class="comment">        "one" bit in the previous ewah bitmap.</span><span class="comment"></span><span class="comment">      - An array of SHA-1. The n-th SHA-1 corresponds with the n-th "one" bit</span><span class="comment">        in the previous ewah bitmap.</span><span class="comment"></span><span class="comment">      - One NUL.</span><span class="comment"></span><span class="comment">   == File System Monitor cache</span><span class="comment"></span><span class="comment">     The file system monitor cache tracks files for which the core.fsmonitor</span><span class="comment">     hook has told us about changes.  The signature for this extension is</span><span class="comment">     { 'F', 'S', 'M', 'N' }.</span><span class="comment"></span><span class="comment">     The extension starts with</span><span class="comment"></span><span class="comment">     - 32-bit version number: the current supported version is 1.</span><span class="comment"></span><span class="comment">     - 64-bit time: the extension data reflects all changes through the given</span><span class="comment">       time which is stored as the nanoseconds elapsed since midnight,</span><span class="comment">       January 1, 1970.</span><span class="comment"></span><span class="comment">    - 32-bit bitmap size: the size of the CE_FSMONITOR_VALID bitmap.</span><span class="comment"></span><span class="comment">    - An ewah bitmap, the n-th bit indicates whether the n-th index entry</span><span class="comment">      is not CE_FSMONITOR_VALID.</span><span class="comment"></span><span class="comment">  == End of Index Entry</span><span class="comment"></span><span class="comment">    The End of Index Entry (EOIE) is used to locate the end of the variable</span><span class="comment">    length index entries and the beginning of the extensions. Code can take</span><span class="comment">    advantage of this to quickly locate the index extensions without having</span><span class="comment">    to parse through all of the index entries.</span><span class="comment"></span><span class="comment">    Because it must be able to be loaded before the variable length cache</span><span class="comment">    entries and other index extensions, this extension must be written last.</span><span class="comment">    The signature for this extension is { 'E', 'O', 'I', 'E' }.</span><span class="comment"></span><span class="comment">    The extension consists of:</span><span class="comment"></span><span class="comment">    - 32-bit offset to the end of the index entries</span><span class="comment"></span><span class="comment">    - 160-bit SHA-1 over the extension types and their sizes (but not</span><span class="comment">      their contents).  E.g. if we have "TREE" extension that is N-bytes</span><span class="comment">      long, "REUC" extension that is M-bytes long, followed by "EOIE",</span><span class="comment">      then the hash would be:</span><span class="comment"></span><span class="comment">      SHA-1("TREE" + &lt;binary representation of N&gt; +</span><span class="comment">        "REUC" + &lt;binary representation of M&gt;)</span><span class="comment"></span><span class="comment">  == Index Entry Offset Table</span><span class="comment"></span><span class="comment">    The Index Entry Offset Table (IEOT) is used to help address the CPU</span><span class="comment">    cost of loading the index by enabling multi-threading the process of</span><span class="comment">    converting cache entries from the on-disk format to the in-memory format.</span><span class="comment">    The signature for this extension is { 'I', 'E', 'O', 'T' }.</span><span class="comment"></span><span class="comment">    The extension consists of:</span><span class="comment"></span><span class="comment">    - 32-bit version (currently 1)</span><span class="comment"></span><span class="comment">    - A number of index offset entries each consisting of:</span><span class="comment"></span><span class="comment">    - 32-bit offset from the beginning of the file to the first cache entry</span><span class="comment">      in this block of entries.</span><span class="comment"></span><span class="comment">    - 32-bit count of cache entries in this blockpackage index</span></div>
<div class="code"><pre><code></code></pre></div></div>

</div><pre id="footer">
<table><tr><td><img src="../../../../../../../../png/go101-twitter.png"></td>
<td>The pages are generated with <a href="https://go101.org/article/tool-golds.html"><b>Golds</b></a> <i>v0.3.2-preview</i>. (GOOS=darwin GOARCH=amd64)
<b>Golds</b> is a <a href="https://go101.org">Go 101</a> project developed by <a href="https://tapirgames.com">Tapir Liu</a>.
PR and bug reports are welcome and can be submitted to <a href="https://github.com/go101/golds">the issue list</a>.
Please follow <a href="https://twitter.com/go100and1">@Go100and1</a> (reachable from the left QR code) to get the latest news of <b>Golds</b>.</td></tr></table></pre>