<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Source: sqrt.go in package math</title>
<link href="../../css/lightLiterate-v0.3.2-preview.css" rel="stylesheet">
<script src="../../jvs/golds-v0.3.2-preview.js"></script>
<body onload="onPageLoad()"><div>

<pre id="header"><code><span class="title">Source File</span>
	sqrt.go

<span class="title">Belonging Package</span>
	<a href="../../pkg/math.html">math</a>
</code></pre>
<style>input[type=radio] {display: none;}
input[id=r0]:checked ~pre label[for=r0],
input[id=r1]:checked ~pre label[for=r1],
input[id=r2]:checked ~pre label[for=r2],
input[id=r3]:checked ~pre label[for=r3],
input[id=r4]:checked ~pre label[for=r4],
input[id=r5]:checked ~pre label[for=r5],
input[id=r6]:checked ~pre label[for=r6],
input[id=r7]:checked ~pre label[for=r7],
input[id=r8]:checked ~pre label[for=r8],
input[id=r9]:checked ~pre label[for=r9]
{background: #226; color: #ff8;}
{background: brown; color: #eed;}
</style><input id="r0" type="radio" name="g"/>
<input id="r1" type="radio" name="g"/>
<input id="r2" type="radio" name="g"/>
<input id="r3" type="radio" name="g"/>
<input id="r4" type="radio" name="g"/>
<input id="r5" type="radio" name="g"/>
<input id="r6" type="radio" name="g"/>
<input id="r7" type="radio" name="g"/>
<input id="r8" type="radio" name="g"/>
<input id="r9" type="radio" name="g"/>
<div id="container"><div class="section">
<div class="doc">
<span class="comment"> Copyright 2009 The Go Authors. All rights reserved.</span><span class="comment"> Use of this source code is governed by a BSD-style</span><span class="comment"> license that can be found in the LICENSE file.</span></div>
<div class="code"><pre><code>
<span class="keyword">package</span> math
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> The original C code and the long comment below are</span><span class="comment"> from FreeBSD's /usr/src/lib/msun/src/e_sqrt.c and</span><span class="comment"> came with this notice. The go code is a simplified</span><span class="comment"> version of the original C.</span><span class="comment"></span><span class="comment"> ====================================================</span><span class="comment"> Copyright (C) 1993 by Sun Microsystems, Inc. All rights reserved.</span><span class="comment"></span><span class="comment"> Developed at SunPro, a Sun Microsystems, Inc. business.</span><span class="comment"> Permission to use, copy, modify, and distribute this</span><span class="comment"> software is freely granted, provided that this notice</span><span class="comment"> is preserved.</span><span class="comment"> ====================================================</span><span class="comment"></span><span class="comment"> __ieee754_sqrt(x)</span><span class="comment"> Return correctly rounded sqrt.</span><span class="comment">           -----------------------------------------</span><span class="comment">           | Use the hardware sqrt if you have one |</span><span class="comment">           -----------------------------------------</span><span class="comment"> Method:</span><span class="comment">   Bit by bit method using integer arithmetic. (Slow, but portable)</span><span class="comment">   1. Normalization</span><span class="comment">      Scale x to y in [1,4) with even powers of 2:</span><span class="comment">      find an integer k such that  1 &lt;= (y=x*2**(2k)) &lt; 4, then</span><span class="comment">              sqrt(x) = 2**k * sqrt(y)</span><span class="comment">   2. Bit by bit computation</span><span class="comment">      Let q  = sqrt(y) truncated to i bit after binary point (q = 1),</span><span class="comment">           i                                                   0</span><span class="comment">                                     i+1         2</span><span class="comment">          s  = 2*q , and      y  =  2   * ( y - q  ).          (1)</span><span class="comment">           i      i            i                 i</span><span class="comment"></span><span class="comment">      To compute q    from q , one checks whether</span><span class="comment">                  i+1       i</span><span class="comment"></span><span class="comment">                            -(i+1) 2</span><span class="comment">                      (q + 2      )  &lt;= y.                     (2)</span><span class="comment">                        i</span><span class="comment">                                                            -(i+1)</span><span class="comment">      If (2) is false, then q   = q ; otherwise q   = q  + 2      .</span><span class="comment">                             i+1   i             i+1   i</span><span class="comment"></span><span class="comment">      With some algebraic manipulation, it is not difficult to see</span><span class="comment">      that (2) is equivalent to</span><span class="comment">                             -(i+1)</span><span class="comment">                      s  +  2       &lt;= y                       (3)</span><span class="comment">                       i                i</span><span class="comment"></span><span class="comment">      The advantage of (3) is that s  and y  can be computed by</span><span class="comment">                                    i      i</span><span class="comment">      the following recurrence formula:</span><span class="comment">          if (3) is false</span><span class="comment"></span><span class="comment">          s     =  s  ,       y    = y   ;                     (4)</span><span class="comment">           i+1      i          i+1    i</span><span class="comment"></span><span class="comment">      otherwise,</span><span class="comment">                         -i                      -(i+1)</span><span class="comment">          s     =  s  + 2  ,  y    = y  -  s  - 2              (5)</span><span class="comment">           i+1      i          i+1    i     i</span><span class="comment"></span><span class="comment">      One may easily use induction to prove (4) and (5).</span><span class="comment">      Note. Since the left hand side of (3) contain only i+2 bits,</span><span class="comment">            it is not necessary to do a full (53-bit) comparison</span><span class="comment">            in (3).</span><span class="comment">   3. Final rounding</span><span class="comment">      After generating the 53 bits result, we compute one more bit.</span><span class="comment">      Together with the remainder, we can decide whether the</span><span class="comment">      result is exact, bigger than 1/2ulp, or less than 1/2ulp</span><span class="comment">      (it will never equal to 1/2ulp).</span><span class="comment">      The rounding mode can be detected by checking whether</span><span class="comment">      huge + tiny is equal to huge, and whether huge - tiny is</span><span class="comment">      equal to huge for some floating point number "huge" and "tiny".</span><span class="comment"></span><span class="comment"></span><span class="comment"> Notes:  Rounding mode detection omitted. The constants "mask", "shift",</span><span class="comment"> and "bias" are found in src/math/bits.go</span></div>
<div class="code"><pre><code></code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> Sqrt returns the square root of x.</span><span class="comment"></span><span class="comment"> Special cases are:</span><span class="comment">	Sqrt(+Inf) = +Inf</span><span class="comment">	Sqrt(±0) = ±0</span><span class="comment">	Sqrt(x &lt; 0) = NaN</span><span class="comment">	Sqrt(NaN) = NaN</span></div>
<div class="code"><pre><code><span class="keyword">func</span> <label for="r0" class="ident"><a href="../../pkg/math.html#name-Sqrt" class="ident">Sqrt</a></label>(<label for="r1" class="ident">x</label> <a href="../../pkg/builtin.html#name-float64" class="ident">float64</a>) <a href="../../pkg/builtin.html#name-float64" class="ident">float64</a>
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> Note: Sqrt is implemented in assembly on some systems.</span><span class="comment"> Others have assembly stubs that jump to func sqrt below.</span><span class="comment"> On systems where Sqrt is a single instruction, the compiler</span><span class="comment"> may turn a direct call into a direct use of that instruction instead.</span></div>
<div class="code"><pre><code>
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> special cases</span></div>
<div class="code"><pre><code>	<span class="keyword">switch</span> {
	<span class="keyword">case</span> <label for="r3" class="ident">x</label> == <span class="lit-number">0</span> || <a href="bits.go.html#line-34" class="ident">IsNaN</a>(<label for="r3" class="ident">x</label>) || <a href="bits.go.html#line-46" class="ident">IsInf</a>(<label for="r3" class="ident">x</label>, <span class="lit-number">1</span>):
		<span class="keyword">return</span> <label for="r3" class="ident">x</label>
	<span class="keyword">case</span> <label for="r3" class="ident">x</label> &lt; <span class="lit-number">0</span>:
		<span class="keyword">return</span> <a href="bits.go.html#line-31" class="ident">NaN</a>()
	}
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> normalize x</span></div>
<div class="code"><pre><code>	<label for="r5" class="ident">exp</label> := <a href="../../pkg/builtin.html#name-int" class="ident">int</a>((<label for="r4" class="ident">ix</label> &gt;&gt; <a href="bits.go.html#line-13" class="ident">shift</a>) &amp; <a href="bits.go.html#line-12" class="ident">mask</a>)
	<span class="keyword">if</span> <label for="r5" class="ident">exp</label> == <span class="lit-number">0</span> { <span class="comment">// subnormal x</span>
		<span class="keyword">for</span> <label for="r4" class="ident">ix</label>&amp;(<span class="lit-number">1</span>&lt;&lt;<a href="bits.go.html#line-13" class="ident">shift</a>) == <span class="lit-number">0</span> {
			<label for="r4" class="ident">ix</label> &lt;&lt;= <span class="lit-number">1</span>
			<label for="r5" class="ident">exp</label>--
		}
		<label for="r5" class="ident">exp</label>++
	}
	<label for="r5" class="ident">exp</label> -= <a href="bits.go.html#line-14" class="ident">bias</a> <span class="comment">// unbias exponent</span>
	<label for="r4" class="ident">ix</label> &amp;^= <a href="bits.go.html#line-12" class="ident">mask</a> &lt;&lt; <a href="bits.go.html#line-13" class="ident">shift</a>
	<label for="r4" class="ident">ix</label> |= <span class="lit-number">1</span> &lt;&lt; <a href="bits.go.html#line-13" class="ident">shift</a>
	<span class="keyword">if</span> <label for="r5" class="ident">exp</label>&amp;<span class="lit-number">1</span> == <span class="lit-number">1</span> { <span class="comment">// odd exp, double x to make it even</span>
		<label for="r4" class="ident">ix</label> &lt;&lt;= <span class="lit-number">1</span>
	}
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> generate sqrt(x) bit by bit</span></div>
<div class="code"><pre><code>	<label for="r4" class="ident">ix</label> &lt;&lt;= <span class="lit-number">1</span>
	<span class="keyword">var</span> <label for="r6" class="ident">q</label>, <label for="r7" class="ident">s</label> <a href="../../pkg/builtin.html#name-uint64" class="ident">uint64</a>               <span class="comment">// q = sqrt(x)</span>
	<label for="r8" class="ident">r</label> := <a href="../../pkg/builtin.html#name-uint64" class="ident">uint64</a>(<span class="lit-number">1</span> &lt;&lt; (<a href="bits.go.html#line-13" class="ident">shift</a> + <span class="lit-number">1</span>)) <span class="comment">// r = moving bit from MSB to LSB</span>
	<span class="keyword">for</span> <label for="r8" class="ident">r</label> != <span class="lit-number">0</span> {
		<label for="r9" class="ident">t</label> := <label for="r7" class="ident">s</label> + <label for="r8" class="ident">r</label>
		<span class="keyword">if</span> <label for="r9" class="ident">t</label> &lt;= <label for="r4" class="ident">ix</label> {
			<label for="r7" class="ident">s</label> = <label for="r9" class="ident">t</label> + <label for="r8" class="ident">r</label>
			<label for="r4" class="ident">ix</label> -= <label for="r9" class="ident">t</label>
			<label for="r6" class="ident">q</label> += <label for="r8" class="ident">r</label>
		}
		<label for="r4" class="ident">ix</label> &lt;&lt;= <span class="lit-number">1</span>
		<label for="r8" class="ident">r</label> &gt;&gt;= <span class="lit-number">1</span>
</code></pre></div></div>
<div class="section">
<div class="doc">
<span class="comment"> final rounding</span></div>
<div class="code"><pre><code>	<span class="keyword">if</span> <label for="r4" class="ident">ix</label> != <span class="lit-number">0</span> { <span class="comment">// remainder, result not exact</span>
		<label for="r6" class="ident">q</label> += <label for="r6" class="ident">q</label> &amp; <span class="lit-number">1</span> <span class="comment">// round according to extra bit</span>
	}
	<label for="r4" class="ident">ix</label> = <label for="r6" class="ident">q</label>&gt;&gt;<span class="lit-number">1</span> + <a href="../../pkg/builtin.html#name-uint64" class="ident">uint64</a>(<label for="r5" class="ident">exp</label>-<span class="lit-number">1</span>+<a href="bits.go.html#line-14" class="ident">bias</a>)&lt;&lt;<a href="bits.go.html#line-13" class="ident">shift</a> <span class="comment">// significand + biased exponent</span>
	<span class="keyword">return</span> <a href="unsafe.go.html#line-29" class="ident">Float64frombits</a>(<label for="r4" class="ident">ix</label>)
</code></pre></div></div>

</div><pre id="footer">
<table><tr><td><img src="../../png/go101-twitter.png"></td>
<td>The pages are generated with <a href="https://go101.org/article/tool-golds.html"><b>Golds</b></a> <i>v0.3.2-preview</i>. (GOOS=darwin GOARCH=amd64)
<b>Golds</b> is a <a href="https://go101.org">Go 101</a> project developed by <a href="https://tapirgames.com">Tapir Liu</a>.
PR and bug reports are welcome and can be submitted to <a href="https://github.com/go101/golds">the issue list</a>.
Please follow <a href="https://twitter.com/go100and1">@Go100and1</a> (reachable from the left QR code) to get the latest news of <b>Golds</b>.</td></tr></table></pre>